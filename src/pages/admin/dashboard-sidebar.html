<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CodeSmart</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="../../css/admin-sidebar.css">
    <link rel="stylesheet" href="../../css/notification.css">
    <link rel="stylesheet" href="../../css/modal-system.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <a href="dashboard-sidebar.html" class="sidebar-logo">
                <i class='bx bx-code-alt'></i>
                <span>CodeSmart</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="dashboard-sidebar.html" class="nav-item active">
                    <i class='bx bx-home-alt'></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="users-sidebar.html" class="nav-item">
                    <i class='bx bx-user'></i>
                    <span>Users</span>
                </a>
                <a href="modules-sidebar.html" class="nav-item">
                    <i class='bx bx-book'></i>
                    <span>Modules</span>
                </a>
                <a href="assignments-sidebar.html" class="nav-item">
                    <i class='bx bx-task'></i>
                    <span>Assignments</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a href="reports-sidebar.html" class="nav-item">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    <span>Reports</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="#" class="nav-item" onclick="logout()">
                    <i class='bx bx-log-out'></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="page-title-header">Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="header-icon">
                    <i class='bx bx-bell'></i>
                    <span class="notification-badge"></span>
                </div>
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class='bx bx-user'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class='bx bx-book'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalModules">0</h3>
                        <p>Total Modules</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class='bx bx-task'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalAssignments">0</h3>
                        <p>Total Assignments</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class='bx bx-user-check'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Users</h2>
                    <a href="users-sidebar.html" class="btn btn-outline btn-sm">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Registered</th>
                                </tr>
                            </thead>
                            <tbody id="recentUsersTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Assignments -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Assignments</h2>
                    <a href="assignments-sidebar.html" class="btn btn-outline btn-sm">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Module</th>
                                    <th>Class</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentAssignmentsTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/src/js/auth.js"></script>
    <script src="/src/js/api-service.js"></script>
    <script src="/src/js/notification-service.js"></script>
    <script src="/src/js/modal-service.js"></script>
    <script>
        // Auth check
        if (!authService.requireAuth() || !authService.isAdmin()) {
            window.location.href = '/src/pages/auth/login.html';
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load statistics
                const statsResponse = await apiService.getAdminStatistics();
                if (statsResponse.success) {
                    const stats = statsResponse.data;
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('totalModules').textContent = stats.total_modules || 0;
                    document.getElementById('totalAssignments').textContent = stats.total_assignments || 0;
                    document.getElementById('activeUsers').textContent = stats.active_users || 0;
                }

                // Load recent users
                const usersResponse = await apiService.getAllUsers();
                if (usersResponse.success) {
                    const users = (usersResponse.data.users || usersResponse.data || []).slice(0, 5); // Latest 5
                    renderRecentUsers(users);
                }

                // Load recent assignments
                const assignmentsResponse = await apiService.getAllAssignments();
                if (assignmentsResponse.success) {
                    const assignments = (assignmentsResponse.data.assignments || assignmentsResponse.data || []).slice(0, 5);
                    renderRecentAssignments(assignments);
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function renderRecentUsers(users) {
            const tbody = document.getElementById('recentUsersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.name || 'N/A'}</strong></td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-info">${user.role}</span></td>
                    <td><span class="badge badge-${user.status === 'active' ? 'success' : 'warning'}">${user.status}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        function renderRecentAssignments(assignments) {
            const tbody = document.getElementById('recentAssignmentsTable');
            if (assignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">No assignments found</td></tr>';
                return;
            }

            tbody.innerHTML = assignments.map(assignment => `
                <tr>
                    <td><strong>${assignment.title}</strong></td>
                    <td>${assignment.module_name}</td>
                    <td>Class ${assignment.class_number}</td>
                    <td>${new Date(assignment.due_date).toLocaleDateString()}</td>
                    <td><span class="badge badge-${assignment.is_active ? 'success' : 'danger'}">${assignment.is_active ? 'Active' : 'Inactive'}</span></td>
                </tr>
            `).join('');
        }

        function logout() {
            modalService.confirm({
                title: 'Logout',
                message: 'Are you sure you want to logout?',
                confirmText: 'Logout',
                danger: true,
                onConfirm: () => {
                    authService.logout();
                }
            });
        }

        // Set user info
        const currentUser = authService.getCurrentUser();
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name || 'Admin';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'A')[0].toUpperCase();
        }

        // Initialize
        loadDashboardData();
    </script>
</body>
</html>
