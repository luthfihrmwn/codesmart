<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - CodeSmart</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="../../css/admin-sidebar.css">
    <link rel="stylesheet" href="../../css/notification.css">
    <link rel="stylesheet" href="../../css/modal-system.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <a href="dashboard-sidebar.html" class="sidebar-logo">
                <i class='bx bx-code-alt'></i>
                <span>CodeSmart</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="dashboard-sidebar.html" class="nav-item">
                    <i class='bx bx-home-alt'></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="users-sidebar.html" class="nav-item">
                    <i class='bx bx-user'></i>
                    <span>Users</span>
                </a>
                <a href="classes-sidebar.html" class="nav-item">
                    <i class='bx bx-book-open'></i>
                    <span>Classes</span>
                </a>
                <a href="modules-sidebar.html" class="nav-item">
                    <i class='bx bx-book'></i>
                    <span>Modules</span>
                </a>
                <a href="materials-sidebar.html" class="nav-item">
                    <i class='bx bx-folder-open'></i>
                    <span>Materials</span>
                </a>
                <a href="assignments-sidebar.html" class="nav-item">
                    <i class='bx bx-task'></i>
                    <span>Assignments</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Content</div>
                <a href="submissions-sidebar.html" class="nav-item">
                    <i class='bx bx-file'></i>
                    <span>Submissions</span>
                </a>
                <a href="discussions-sidebar.html" class="nav-item">
                    <i class='bx bx-message-square-dots'></i>
                    <span>Discussions</span>
                </a>
                <a href="announcements-sidebar.html" class="nav-item">
                    <i class='bx bx-broadcast'></i>
                    <span>Announcements</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a href="reports-sidebar.html" class="nav-item active">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    <span>Reports</span>
                </a>
            </div>

            
        </nav>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="page-title-header">Reports & Analytics</h1>
            </div>
            <div class="header-right">
                <div class="notification-bell" id="notificationBellBtn">
                    <i class='bx bx-bell'></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </div>
                <div class="user-menu" id="userMenuToggle">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>

                    <!-- User Dropdown -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-user-name" id="dropdownUserName">Administrator</div>
                            <div class="dropdown-user-email" id="dropdownUserEmail">admin@codesmart.com</div>
                        </div>
                        <div class="dropdown-menu">
                            <a href="profile.html" class="dropdown-item">
                                <i class='bx bx-user-circle'></i>
                                <span>My Profile</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item danger" onclick="logout(); return false;">
                                <i class='bx bx-log-out'></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Overview Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class='bx bx-user'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class='bx bx-user-check'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class='bx bx-book'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalModules">0</h3>
                        <p>Total Modules</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class='bx bx-task'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalAssignments">0</h3>
                        <p>Total Assignments</p>
                    </div>
                </div>
            </div>

            <!-- User Statistics by Level -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Users by Level</h2>
                </div>
                <div class="card-body">
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class='bx bx-trophy'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="fundamentalUsers">0</h3>
                                <p>Fundamental</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class='bx bx-trophy'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="intermediateUsers">0</h3>
                                <p>Intermediate</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class='bx bx-trophy'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="advanceUsers">0</h3>
                                <p>Advance</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon secondary">
                                <i class='bx bx-question-mark'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="noLevelUsers">0</h3>
                                <p>No Level</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module Enrollment Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Module Enrollments</h2>
                    <button onclick="exportModuleEnrollmentsCSV()" class="btn-primary" style="padding: 8px 16px; background: #10b981; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; gap: 8px;">
                        <i class='bx bx-download'></i> Export CSV
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Module</th>
                                    <th>Level</th>
                                    <th>Total Enrollments</th>
                                    <th>Active Users</th>
                                    <th>Classes</th>
                                    <th>Assignments</th>
                                </tr>
                            </thead>
                            <tbody id="moduleStatsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Assignment Submission Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Assignment Submissions</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <select id="moduleFilterAssignments" class="form-input" style="max-width: 250px;">
                            <option value="">All Modules</option>
                        </select>
                        <button onclick="exportAssignmentSubmissionsCSV()" class="btn-primary" style="padding: 8px 16px; background: #10b981; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                            <i class='bx bx-download'></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Assignment</th>
                                    <th>Module</th>
                                    <th>Total Submissions</th>
                                    <th>Graded</th>
                                    <th>Pending</th>
                                    <th>Average Score</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentStatsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Activity Log -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent User Activity</h2>
                    <button onclick="exportUserActivityCSV()" class="btn-primary" style="padding: 8px 16px; background: #10b981; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; gap: 8px;">
                        <i class='bx bx-download'></i> Export CSV
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Level</th>
                                    <th>Pretest Score</th>
                                    <th>Enrollments</th>
                                    <th>Last Active</th>
                                </tr>
                            </thead>
                            <tbody id="userActivityTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SVM Predictions Analytics Section -->
            <div class="card" style="margin-top: 32px;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <h2 class="card-title">
                        <i class='bx bx-brain'></i>
                        SVM Predictions Analytics
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="loadSVMData()" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            <i class='bx bx-refresh'></i> Refresh
                        </button>
                        <button onclick="runSVMBatchPrediction()" style="padding: 8px 16px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            <i class='bx bx-play-circle'></i> Run Batch
                        </button>
                        <button onclick="exportSVMPredictionsCSV()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class='bx bx-download'></i> Export CSV
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- SVM Stats Grid -->
                    <div id="svmStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin: 24px 0;">
                        <div style="text-align: center; padding: 20px;">
                            <i class='bx bx-loader-alt bx-spin' style="font-size: 32px; color: #667eea;"></i>
                            <p style="margin-top: 12px; color: #6b7280;">Loading SVM data...</p>
                        </div>
                    </div>

                    <!-- SVM Charts -->
                    <div id="svmChartsContainer" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px;">
                            <div>
                                <h4 style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 16px;">Level Distribution</h4>
                                <div style="position: relative; height: 280px;">
                                    <canvas id="svmLevelChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 16px;">Confidence Distribution</h4>
                                <div style="position: relative; height: 280px;">
                                    <canvas id="svmConfidenceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SVM Table -->
                    <div id="svmTableContainer" style="display: none;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #2d3748; margin: 24px 0 16px 0;">Top 10 Recent Predictions</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Student</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Score</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Rule-Based</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">SVM</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Confidence</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Match</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="svmPredictionsBody" style="background: white;">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="svmEmptyState" style="display: none; text-align: center; padding: 40px;">
                        <i class='bx bx-brain' style="font-size: 64px; color: #cbd5e0;"></i>
                        <h4 style="color: #4a5568; margin-top: 16px;">No SVM Predictions Yet</h4>
                        <p style="color: #718096; margin: 8px 0 24px 0;">Run batch prediction to generate SVM predictions</p>
                        <button onclick="runSVMBatchPrediction()" style="padding: 12px 24px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            <i class='bx bx-play-circle'></i> Run Batch Prediction
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/src/js/api-service.js"></script>
    <script src="/src/js/auth.js"></script>
    <script src="/src/js/notification-service.js"></script>
    <script src="/src/js/notification-bell.js"></script>
    <script src="/src/js/modal-service.js"></script>
    <script src="/src/js/svm-modal.js"></script>
    <script>
        // Auth check
        if (!authService.requireAuth() || !authService.isAdmin()) {
            window.location.href = '/src/pages/auth/login.html';
        }

        let allUsers = [];
        let allModules = [];
        let allAssignments = [];
        let assignmentSubmissions = {};

        // Load all data
        async function loadAllData() {
            try {
                // Load sequentially to avoid rate limiting (429 errors)
                await loadStatistics();
                await loadUsers();
                await loadModules();
                await loadAssignments();
                renderAllReports();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await apiService.getAdminStatistics();
                if (response.success) {
                    const stats = response.data;
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('activeUsers').textContent = stats.active_users || 0;
                    document.getElementById('totalModules').textContent = stats.total_modules || 0;
                    document.getElementById('totalAssignments').textContent = stats.total_assignments || 0;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load users - filter only role 'user'
        async function loadUsers() {
            try {
                const response = await apiService.getAllUsers();
                if (response.success) {
                    const allUsersData = response.data.users || response.data || [];
                    // Filter only users with role 'user' (not 'admin' or 'assessor')
                    allUsers = allUsersData.filter(user => user.role === 'user');
                    console.log('Loaded users:', allUsers.length);
                    calculateUserLevels();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Calculate user level statistics
        function calculateUserLevels() {
            const levels = {
                fundamental: 0,
                intermediate: 0,
                advance: 0,
                none: 0
            };

            allUsers.forEach(user => {
                if (user.level) {
                    levels[user.level] = (levels[user.level] || 0) + 1;
                } else {
                    levels.none++;
                }
            });

            document.getElementById('fundamentalUsers').textContent = levels.fundamental;
            document.getElementById('intermediateUsers').textContent = levels.intermediate;
            document.getElementById('advanceUsers').textContent = levels.advance;
            document.getElementById('noLevelUsers').textContent = levels.none;
        }

        // Load modules
        async function loadModules() {
            try {
                const response = await apiService.getAllModules();
                if (response.success) {
                    const modulesData = response.data.modules || response.data || [];
                    allModules = Array.isArray(modulesData) ? modulesData : [];
                    console.log('Loaded modules:', allModules.length);
                    populateModuleFilter();
                }
            } catch (error) {
                console.error('Error loading modules:', error);
                allModules = [];
            }
        }

        // Populate module filter
        function populateModuleFilter() {
            const select = document.getElementById('moduleFilterAssignments');
            if (select && allModules.length > 0) {
                const options = allModules.map(m =>
                    `<option value="${m.slug}">${m.name}</option>`
                ).join('');
                select.innerHTML = '<option value="">All Modules</option>' + options;
            }
        }

        // Load assignments
        async function loadAssignments() {
            try {
                const response = await apiService.getAllAssignments();
                if (response.success) {
                    const assignmentsData = response.data.assignments || response.data || [];
                    allAssignments = Array.isArray(assignmentsData) ? assignmentsData : [];
                    console.log('Loaded assignments:', allAssignments.length);

                    // Load submissions for each assignment
                    await loadAssignmentSubmissions();
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                allAssignments = [];
            }
        }

        // Load assignment submissions
        async function loadAssignmentSubmissions() {
            try {
                // Load all submissions at once instead of per assignment to avoid rate limit
                const response = await apiService.fetchWithAuth('/admin/submissions');
                if (response.success) {
                    const allSubmissions = Array.isArray(response.data) ? response.data : [];
                    console.log('Loaded all submissions:', allSubmissions.length);

                    // Group submissions by assignment_id
                    assignmentSubmissions = {};
                    allSubmissions.forEach(submission => {
                        const assignmentId = submission.assignment_id;
                        if (!assignmentSubmissions[assignmentId]) {
                            assignmentSubmissions[assignmentId] = [];
                        }
                        assignmentSubmissions[assignmentId].push(submission);
                    });
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                assignmentSubmissions = {};
            }
        }

        // Render all reports
        function renderAllReports() {
            renderModuleStats();
            renderAssignmentStats();
            renderUserActivity();
        }

        // Render module statistics
        function renderModuleStats() {
            const tbody = document.getElementById('moduleStatsTable');

            if (allModules.length === 0) {
                // Show dummy data
                const dummyModules = [
                    { name: 'Introduction to Programming', level: 'fundamental', enrollments: 45, active: 42, classes: 5, assignments: 8 },
                    { name: 'Data Structures & Algorithms', level: 'intermediate', enrollments: 32, active: 28, classes: 6, assignments: 10 },
                    { name: 'Advanced Web Development', level: 'advance', enrollments: 18, active: 15, classes: 4, assignments: 12 }
                ];

                tbody.innerHTML = `
                    <tr style="background-color: #fff9e6; border-left: 4px solid #f59e0b;">
                        <td colspan="6" style="text-align:center;padding:12px;">
                            <i class='bx bx-info-circle' style="color:#f59e0b;"></i>
                            <strong style="color:#f59e0b;"> Sample Data</strong> - No actual modules found. The data below is for demonstration purposes.
                        </td>
                    </tr>
                ` + dummyModules.map(module => `
                    <tr style="opacity: 0.7;">
                        <td><strong>${module.name}</strong></td>
                        <td><span class="badge badge-${getLevelColor(module.level)}">${module.level}</span></td>
                        <td>${module.enrollments}</td>
                        <td>${module.active}</td>
                        <td>${module.classes}</td>
                        <td>${module.assignments}</td>
                    </tr>
                `).join('');
                return;
            }

            tbody.innerHTML = allModules.map(module => {
                return `
                    <tr>
                        <td><strong>${module.name}</strong></td>
                        <td><span class="badge badge-${getLevelColor(module.level)}">${module.level}</span></td>
                        <td>${module.total_enrollments || 0}</td>
                        <td>${module.total_enrollments || 0}</td>
                        <td>${module.total_classes || 0}</td>
                        <td>${module.total_assignments || 0}</td>
                    </tr>
                `;
            }).join('');
        }

        // Render assignment statistics
        function renderAssignmentStats(moduleFilter = '') {
            const tbody = document.getElementById('assignmentStatsTable');
            const filtered = moduleFilter ?
                allAssignments.filter(a => a.module_slug === moduleFilter) :
                allAssignments;

            if (filtered.length === 0) {
                // Show dummy data
                const dummyAssignments = [
                    { title: 'Variables & Data Types Quiz', module: 'Introduction to Programming', submissions: 42, graded: 38, pending: 4, avgScore: 82.5, maxScore: 100 },
                    { title: 'Binary Search Implementation', module: 'Data Structures & Algorithms', submissions: 28, graded: 25, pending: 3, avgScore: 75.8, maxScore: 100 },
                    { title: 'REST API Development', module: 'Advanced Web Development', submissions: 15, graded: 12, pending: 3, avgScore: 88.3, maxScore: 100 },
                    { title: 'Sorting Algorithms Project', module: 'Data Structures & Algorithms', submissions: 30, graded: 30, pending: 0, avgScore: 79.2, maxScore: 100 }
                ];

                tbody.innerHTML = `
                    <tr style="background-color: #fff9e6; border-left: 4px solid #f59e0b;">
                        <td colspan="6" style="text-align:center;padding:12px;">
                            <i class='bx bx-info-circle' style="color:#f59e0b;"></i>
                            <strong style="color:#f59e0b;"> Sample Data</strong> - No actual assignments found. The data below is for demonstration purposes.
                        </td>
                    </tr>
                ` + dummyAssignments.map(assignment => `
                    <tr style="opacity: 0.7;">
                        <td><strong>${assignment.title}</strong></td>
                        <td>${assignment.module}</td>
                        <td>${assignment.submissions}</td>
                        <td><span class="badge badge-success">${assignment.graded}</span></td>
                        <td><span class="badge badge-warning">${assignment.pending}</span></td>
                        <td>${assignment.avgScore}/${assignment.maxScore}</td>
                    </tr>
                `).join('');
                return;
            }

            tbody.innerHTML = filtered.map(assignment => {
                const submissions = assignmentSubmissions[assignment.id] || [];
                const graded = submissions.filter(s => s.status === 'graded').length;
                const pending = submissions.filter(s => s.status === 'pending' || s.status === 'submitted').length;

                const scores = submissions.filter(s => s.score !== null).map(s => s.score);
                const avgScore = scores.length > 0 ?
                    (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) :
                    '-';

                return `
                    <tr>
                        <td><strong>${assignment.title}</strong></td>
                        <td>${assignment.module_name}</td>
                        <td>${submissions.length}</td>
                        <td><span class="badge badge-success">${graded}</span></td>
                        <td><span class="badge badge-warning">${pending}</span></td>
                        <td>${avgScore !== '-' ? avgScore + '/' + assignment.max_score : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Render user activity
        function renderUserActivity() {
            const tbody = document.getElementById('userActivityTable');

            if (allUsers.length === 0) {
                // Show dummy data
                const dummyUsers = [
                    { name: 'John Doe', email: 'john.doe@example.com', role: 'student', level: 'intermediate', pretestScore: 75, enrollments: 3, lastActive: '2025-11-08 14:30:00' },
                    { name: 'Jane Smith', email: 'jane.smith@example.com', role: 'student', level: 'fundamental', pretestScore: 65, enrollments: 2, lastActive: '2025-11-08 13:15:00' },
                    { name: 'Michael Johnson', email: 'michael.j@example.com', role: 'student', level: 'advance', pretestScore: 90, enrollments: 4, lastActive: '2025-11-08 11:45:00' },
                    { name: 'Sarah Williams', email: 'sarah.w@example.com', role: 'student', level: 'intermediate', pretestScore: 80, enrollments: 3, lastActive: '2025-11-08 10:20:00' },
                    { name: 'David Brown', email: 'david.b@example.com', role: 'student', level: 'fundamental', pretestScore: 70, enrollments: 2, lastActive: '2025-11-08 09:00:00' }
                ];

                tbody.innerHTML = `
                    <tr style="background-color: #fff9e6; border-left: 4px solid #f59e0b;">
                        <td colspan="7" style="text-align:center;padding:12px;">
                            <i class='bx bx-info-circle' style="color:#f59e0b;"></i>
                            <strong style="color:#f59e0b;"> Sample Data</strong> - No actual users found. The data below is for demonstration purposes.
                        </td>
                    </tr>
                ` + dummyUsers.map(user => `
                    <tr style="opacity: 0.7;">
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-info">${user.role === 'user' ? 'STUDENT' : user.role.toUpperCase()}</span></td>
                        <td><span class="badge badge-${getLevelColor(user.level)}">${user.level}</span></td>
                        <td>${user.pretestScore}</td>
                        <td>${user.enrollments}</td>
                        <td>${user.lastActive}</td>
                    </tr>
                `).join('');
                return;
            }

            // Sort by created_at (most recent first)
            const sortedUsers = [...allUsers].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            tbody.innerHTML = sortedUsers.map(user => {
                // Use enrollment count from user object if available
                const enrollmentCount = user.enrollment_count || user.total_enrollments || 0;

                return `
                    <tr>
                        <td><strong>${user.name || 'N/A'}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-info">${user.role === 'user' ? 'STUDENT' : user.role.toUpperCase()}</span></td>
                        <td>${user.level ? `<span class="badge badge-${getLevelColor(user.level)}">${user.level}</span>` : '-'}</td>
                        <td>${user.pretest_score !== null ? user.pretest_score : '-'}</td>
                        <td>${enrollmentCount}</td>
                        <td>${new Date(user.created_at).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // Export user data to CSV
        function exportUserData() {
            const headers = ['Name', 'Email', 'Role', 'Level', 'Pretest Score', 'Status', 'Registered'];
            const rows = allUsers.map(user => [
                user.name || 'N/A',
                user.email,
                user.role,
                user.level || '-',
                user.pretest_score !== null ? user.pretest_score : '-',
                user.status,
                new Date(user.created_at).toLocaleDateString()
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `codesmart-users-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Helper functions
        function getLevelColor(level) {
            switch (level) {
                case 'fundamental': return 'success';
                case 'intermediate': return 'warning';
                case 'advance': return 'danger';
                default: return 'secondary';
            }
        }

        function logout() {
            modalService.confirm({
                title: '<i class=\'bx bx-log-out\'></i> Confirm Logout',
                message: 'Are you sure you want to logout from CodeSmart Admin Dashboard?',
                confirmText: 'Yes, Logout',
                cancelText: 'Cancel',
                danger: true,
                onConfirm: function() {
                    authService.logout();
                }
            });
        }

        // CSV Export Functions
        function exportToCSV(data, filename) {
            const csv = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportModuleEnrollmentsCSV() {
            const csvData = [
                ['Module', 'Level', 'Total Enrollments', 'Active Users', 'Classes', 'Assignments']
            ];

            allModules.forEach(module => {
                csvData.push([
                    module.name || 'N/A',
                    module.level || 'N/A',
                    '0', // Total Enrollments
                    '0', // Active Users
                    '0', // Classes
                    '0'  // Assignments
                ]);
            });

            exportToCSV(csvData, 'module_enrollments_' + new Date().toISOString().split('T')[0] + '.csv');

            modalService.addNotification({
                title: 'Export Successful',
                message: 'Module Enrollments data exported to CSV',
                type: 'success'
            });
        }

        function exportAssignmentSubmissionsCSV() {
            const csvData = [
                ['Assignment', 'Module', 'Total Submissions', 'Graded', 'Pending', 'Average Score']
            ];

            const moduleFilter = document.getElementById('moduleFilterAssignments').value;
            const filtered = moduleFilter ?
                allAssignments.filter(a => a.module_id == moduleFilter) :
                allAssignments;

            filtered.forEach(assignment => {
                const submissions = assignmentSubmissions[assignment.id] || [];
                const graded = submissions.filter(s => s.status === 'graded').length;
                const pending = submissions.filter(s => s.status === 'pending' || s.status === 'submitted').length;
                const totalScore = submissions
                    .filter(s => s.score !== null && s.score !== undefined)
                    .reduce((sum, s) => sum + parseFloat(s.score || 0), 0);
                const avgScore = submissions.length > 0 ? (totalScore / submissions.length).toFixed(2) : 'N/A';

                const moduleName = allModules.find(m => m.id === assignment.module_id)?.name || 'N/A';

                csvData.push([
                    assignment.title || 'N/A',
                    moduleName,
                    submissions.length,
                    graded,
                    pending,
                    avgScore
                ]);
            });

            exportToCSV(csvData, 'assignment_submissions_' + new Date().toISOString().split('T')[0] + '.csv');

            modalService.addNotification({
                title: 'Export Successful',
                message: 'Assignment Submissions data exported to CSV',
                type: 'success'
            });
        }

        function exportUserActivityCSV() {
            const csvData = [
                ['User', 'Email', 'Level', 'Last Active', 'Completed Assignments', 'Pending Assignments']
            ];

            allUsers.forEach(user => {
                csvData.push([
                    user.name || 'N/A',
                    user.email || 'N/A',
                    user.level || 'N/A',
                    user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never',
                    '0', // Completed - would need actual data
                    '0'  // Pending - would need actual data
                ]);
            });

            exportToCSV(csvData, 'user_activity_' + new Date().toISOString().split('T')[0] + '.csv');

            modalService.addNotification({
                title: 'Export Successful',
                message: 'User Activity data exported to CSV',
                type: 'success'
            });
        }

        function exportSVMPredictionsCSV() {
            if (svmPredictionsData.length === 0) {
                modalService.addNotification({
                    title: 'No Data',
                    message: 'No SVM predictions available to export',
                    type: 'warning'
                });
                return;
            }

            const csvData = [
                ['Student', 'Score', 'Rule-Based', 'SVM', 'Confidence (%)', 'Match', 'Date']
            ];

            svmPredictionsData.forEach(pred => {
                const match = pred.current_level === pred.svm_predicted_level;
                const matchText = match ? 'Match' : 'Different';

                csvData.push([
                    pred.name || 'Unknown',
                    pred.pretest_score || 0,
                    pred.current_level || '-',
                    pred.svm_predicted_level || '-',
                    (pred.svm_confidence || 0).toFixed(1),
                    matchText,
                    pred.prediction_date ? new Date(pred.prediction_date).toLocaleDateString() : '-'
                ]);
            });

            exportToCSV(csvData, 'svm_predictions_' + new Date().toISOString().split('T')[0] + '.csv');

            modalService.addNotification({
                title: 'Export Successful',
                message: `${svmPredictionsData.length} SVM predictions exported to CSV`,
                type: 'success'
            });
        }

        // Set user info
        const currentUser = authService.getCurrentUser();
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name || 'Admin';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'A')[0].toUpperCase();
        }

        // Event listener for module filter
        document.getElementById('moduleFilterAssignments').addEventListener('change', function() {
            renderAssignmentStats(this.value);
        });

        // Add click handler for notification bell - make sure it works
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBell = document.querySelector('.notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Notification bell clicked');
                    if (typeof modalService !== 'undefined' && modalService.showNotifications) {
                        modalService.showNotifications();
                    } else {
                        console.error('modalService not found');
                    }
                });
                console.log('Notification bell event listener attached');
            }
        });

        // Add welcome notification after 1 second
        setTimeout(() => {
            modalService.addNotification({
                title: 'Welcome to Reports & Analytics',
                message: 'View comprehensive reports and insights about student performance',
                type: 'success'
            });
        }, 1000);

        // Add sample notifications for demo
        setTimeout(() => {
            modalService.addNotification({
                title: 'Report Generated',
                message: 'Monthly performance report is ready to download',
                type: 'info'
            });
        }, 2500);

        // Initialize
        loadAllData();

        // ========================================
        // SVM Analytics Functions
        // ========================================
        let svmPredictionsData = [];
        let svmLevelChart = null;
        let svmConfidenceChart = null;

        // Initialize SVM charts
        function initSVMCharts() {
            const levelCtx = document.getElementById('svmLevelChart')?.getContext('2d');
            if (levelCtx && !svmLevelChart) {
                svmLevelChart = new Chart(levelCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Fundamental', 'Intermediate', 'Advance'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#fa709a', '#4facfe', '#43e97b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const confCtx = document.getElementById('svmConfidenceChart')?.getContext('2d');
            if (confCtx && !svmConfidenceChart) {
                svmConfidenceChart = new Chart(confCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%'],
                        datasets: [{
                            label: 'Predictions',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(102, 126, 234, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        // Update SVM charts
        function updateSVMCharts(predictions) {
            if (!svmLevelChart || !svmConfidenceChart) return;

            const levelCounts = {
                fundamental: predictions.filter(p => p.svm_predicted_level === 'fundamental').length,
                intermediate: predictions.filter(p => p.svm_predicted_level === 'intermediate').length,
                advance: predictions.filter(p => p.svm_predicted_level === 'advance').length
            };

            svmLevelChart.data.datasets[0].data = [levelCounts.fundamental, levelCounts.intermediate, levelCounts.advance];
            svmLevelChart.update();

            const confRanges = [0, 0, 0, 0, 0];
            predictions.forEach(p => {
                const conf = p.svm_confidence || 0;
                if (conf <= 20) confRanges[0]++;
                else if (conf <= 40) confRanges[1]++;
                else if (conf <= 60) confRanges[2]++;
                else if (conf <= 80) confRanges[3]++;
                else confRanges[4]++;
            });

            svmConfidenceChart.data.datasets[0].data = confRanges;
            svmConfidenceChart.update();
        }

        // Load SVM data
        async function loadSVMData() {
            try {
                const response = await apiService.getSVMStats();

                if (response.success && response.data.statistics.total_predictions > 0) {
                    const stats = response.data.statistics;
                    const predictions = response.data.predictions || [];

                    // Update stats grid
                    const statsHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${stats.total_predictions}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Total Predictions</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #fa709a;">${stats.fundamental_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Fundamental</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #4facfe;">${stats.intermediate_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Intermediate</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #43e97b;">${stats.advance_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Advance</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #10b981;">${stats.matching_predictions}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Matching</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #667eea;">${(stats.avg_confidence || 0).toFixed(1)}%</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Avg Confidence</div>
                        </div>
                    `;
                    document.getElementById('svmStatsGrid').innerHTML = statsHTML;

                    // Initialize and update charts
                    initSVMCharts();
                    updateSVMCharts(predictions);

                    // Render table
                    renderSVMTable(predictions);
                    svmPredictionsData = predictions;

                    // Show charts and table
                    document.getElementById('svmChartsContainer').style.display = 'block';
                    document.getElementById('svmTableContainer').style.display = 'block';
                    document.getElementById('svmEmptyState').style.display = 'none';
                } else {
                    showSVMEmptyState();
                }
            } catch (error) {
                console.error('Error loading SVM data:', error);
                showSVMEmptyState();
            }
        }

        // Render SVM table
        function renderSVMTable(predictions) {
            const tbody = document.getElementById('svmPredictionsBody');
            tbody.innerHTML = '';

            predictions.slice(0, 10).forEach(pred => {
                const match = pred.current_level === pred.svm_predicted_level;
                const matchText = match ? ' Match' : ' Different';
                const matchColor = match ? '#10b981' : '#ef4444';

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e5e7eb';
                row.style.cursor = 'pointer';
                row.style.transition = 'all 0.2s';

                // Add hover effect
                row.addEventListener('mouseenter', function() {
                    this.style.background = '#f8fafc';
                    this.style.transform = 'scale(1.01)';
                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                });

                row.addEventListener('mouseleave', function() {
                    this.style.background = '';
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });

                // Add click handler to show modal
                row.addEventListener('click', function() {
                    svmModal.show(pred);
                });

                row.innerHTML = `
                    <td style="padding: 12px; font-size: 13px;"><strong>${pred.name || 'Unknown'}</strong></td>
                    <td style="padding: 12px; font-size: 13px;">${pred.pretest_score || 0}</td>
                    <td style="padding: 12px; font-size: 13px;"><span style="padding: 4px 8px; border-radius: 6px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-size: 11px; font-weight: 600;">${pred.current_level || '-'}</span></td>
                    <td style="padding: 12px; font-size: 13px;"><span style="padding: 4px 8px; border-radius: 6px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; font-size: 11px; font-weight: 600;">${pred.svm_predicted_level || '-'}</span></td>
                    <td style="padding: 12px; font-size: 13px;">
                        <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${pred.svm_confidence || 0}%; height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                        </div>
                        <div style="font-size: 11px; color: #718096; margin-top: 4px;">${(pred.svm_confidence || 0).toFixed(1)}%</div>
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: ${matchColor}; font-weight: 600;">${matchText}</td>
                    <td style="padding: 12px; font-size: 13px; color: #6b7280;">${pred.prediction_date ? new Date(pred.prediction_date).toLocaleDateString() : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Run SVM batch prediction
        async function runSVMBatchPrediction() {
            if (!confirm('Run batch prediction untuk semua siswa dengan pretest?')) return;

            try {
                document.getElementById('svmStatsGrid').innerHTML = '<div style="text-align: center; padding: 20px;"><i class="bx bx-loader-alt bx-spin" style="font-size: 32px; color: #667eea;"></i><p style="margin-top: 12px; color: #6b7280;">Running batch prediction...</p></div>';

                const response = await apiService.fetchWithAuth('/ml/batch-predict', { method: 'POST' });

                if (response.success) {
                    alert(` Batch prediction berhasil!\n\nTotal: ${response.data.total_users}\nSuccess: ${response.data.successful_predictions}\nFailed: ${response.data.failed_predictions}`);
                    loadSVMData();
                } else {
                    alert(' Batch prediction gagal: ' + (response.error || 'Unknown error'));
                    showSVMEmptyState();
                }
            } catch (error) {
                console.error('Error running batch prediction:', error);
                alert(' Error: ' + error.message);
                showSVMEmptyState();
            }
        }

        // Show empty state
        function showSVMEmptyState() {
            document.getElementById('svmStatsGrid').innerHTML = '';
            document.getElementById('svmChartsContainer').style.display = 'none';
            document.getElementById('svmTableContainer').style.display = 'none';
            document.getElementById('svmEmptyState').style.display = 'block';
        }

        // Load SVM data on page load
        setTimeout(() => {
            loadSVMData();
        }, 1500);
    </script>

    <script>
        // User dropdown toggle
        (function() {
            const userMenuToggle = document.getElementById('userMenuToggle');
            const userDropdown = document.getElementById('userDropdown');

            if (userMenuToggle && userDropdown) {
                userMenuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('active');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenuToggle.contains(e.target)) {
                        userDropdown.classList.remove('active');
                    }
                });

                // Update dropdown user info
                const currentUser = authService.getCurrentUser();
                if (currentUser) {
                    const dropdownUserName = document.getElementById('dropdownUserName');
                    const dropdownUserEmail = document.getElementById('dropdownUserEmail');
                    if (dropdownUserName) dropdownUserName.textContent = currentUser.name || 'Admin';
                    if (dropdownUserEmail) dropdownUserEmail.textContent = currentUser.email || '';
                }
            }
        })();
    </script>
</body>
</html>
