<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - CodeSmart</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="../../css/admin-sidebar.css">
    <link rel="stylesheet" href="../../css/notification.css">
    <link rel="stylesheet" href="../../css/modal-system.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <a href="dashboard-sidebar.html" class="sidebar-logo">
                <i class='bx bx-code-alt'></i>
                <span>CodeSmart</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="dashboard-sidebar.html" class="nav-item">
                    <i class='bx bx-home-alt'></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <a href="users-sidebar.html" class="nav-item">
                    <i class='bx bx-user'></i>
                    <span>Users</span>
                </a>
                <a href="modules-sidebar.html" class="nav-item">
                    <i class='bx bx-book'></i>
                    <span>Modules</span>
                </a>
                <a href="assignments-sidebar.html" class="nav-item">
                    <i class='bx bx-task'></i>
                    <span>Assignments</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a href="reports-sidebar.html" class="nav-item active">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    <span>Reports</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="#" class="nav-item" onclick="logout()">
                    <i class='bx bx-log-out'></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="page-title-header">Reports & Analytics</h1>
            </div>
            <div class="header-right">
                <div class="notification-bell" id="notificationBellBtn">
                    <i class='bx bx-bell'></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </div>
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Overview Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class='bx bx-user'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class='bx bx-user-check'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class='bx bx-book'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalModules">0</h3>
                        <p>Total Modules</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class='bx bx-task'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalAssignments">0</h3>
                        <p>Total Assignments</p>
                    </div>
                </div>
            </div>

            <!-- User Statistics by Level -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Users by Level</h2>
                </div>
                <div class="card-body">
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class='bx bx-trophy'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="fundamentalUsers">0</h3>
                                <p>Fundamental</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class='bx bx-trophy'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="intermediateUsers">0</h3>
                                <p>Intermediate</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class='bx bx-trophy'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="advanceUsers">0</h3>
                                <p>Advance</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon secondary">
                                <i class='bx bx-question-mark'></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="noLevelUsers">0</h3>
                                <p>No Level</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module Enrollment Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Module Enrollments</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Module</th>
                                    <th>Level</th>
                                    <th>Total Enrollments</th>
                                    <th>Active Users</th>
                                    <th>Classes</th>
                                    <th>Assignments</th>
                                </tr>
                            </thead>
                            <tbody id="moduleStatsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Assignment Submission Statistics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Assignment Submissions</h2>
                    <select id="moduleFilterAssignments" class="form-input" style="max-width: 250px;">
                        <option value="">All Modules</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Assignment</th>
                                    <th>Module</th>
                                    <th>Total Submissions</th>
                                    <th>Graded</th>
                                    <th>Pending</th>
                                    <th>Average Score</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentStatsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Activity Log -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent User Activity</h2>
                    <button onclick="exportUserData()" class="btn btn-outline btn-sm">
                        <i class='bx bx-export'></i> Export Data
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Level</th>
                                    <th>Pretest Score</th>
                                    <th>Enrollments</th>
                                    <th>Last Active</th>
                                </tr>
                            </thead>
                            <tbody id="userActivityTable">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <div class="loader"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SVM Predictions Analytics Section -->
            <div class="card" style="margin-top: 32px;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <h2 class="card-title">
                        <i class='bx bx-brain'></i>
                        SVM Predictions Analytics
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="loadSVMData()" class="btn btn-primary btn-sm">
                            <i class='bx bx-refresh'></i> Refresh
                        </button>
                        <button onclick="runSVMBatchPrediction()" class="btn btn-success btn-sm">
                            <i class='bx bx-play-circle'></i> Run Batch
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- SVM Stats Grid -->
                    <div id="svmStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center; padding: 20px;">
                            <i class='bx bx-loader-alt bx-spin' style="font-size: 32px; color: #667eea;"></i>
                            <p style="margin-top: 12px; color: #6b7280;">Loading SVM data...</p>
                        </div>
                    </div>

                    <!-- SVM Table -->
                    <div id="svmTableContainer" style="display: none;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #2d3748; margin: 24px 0 16px 0;">Top 10 Recent Predictions</h3>
                        <div class="table-responsive">
                            <table>
                                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Student</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Score</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Rule-Based</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">SVM</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Confidence</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Match</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="svmPredictionsBody" style="background: white;">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="svmEmptyState" style="display: none; text-align: center; padding: 40px;">
                        <i class='bx bx-brain' style="font-size: 64px; color: #cbd5e0;"></i>
                        <h4 style="color: #4a5568; margin-top: 16px;">No SVM Predictions Yet</h4>
                        <p style="color: #718096; margin: 8px 0 24px 0;">Run batch prediction to generate SVM predictions</p>
                        <button onclick="runSVMBatchPrediction()" class="btn btn-success">
                            <i class='bx bx-play-circle'></i> Run Batch Prediction
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/src/js/auth.js"></script>
    <script src="/src/js/api-service.js"></script>
    <script src="/src/js/notification-service.js"></script>
    <script src="/src/js/notification-bell.js"></script>
    <script src="/src/js/modal-service.js"></script>
    <script>
        // Auth check
        if (!authService.requireAuth() || !authService.isAdmin()) {
            window.location.href = '/src/pages/auth/login.html';
        }

        let allUsers = [];
        let allModules = [];
        let allAssignments = [];
        let assignmentSubmissions = {};

        // Load all data
        async function loadAllData() {
            try {
                await Promise.all([
                    loadStatistics(),
                    loadUsers(),
                    loadModules(),
                    loadAssignments()
                ]);
                renderAllReports();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await apiService.getAdminStatistics();
                if (response.success) {
                    const stats = response.data;
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('activeUsers').textContent = stats.active_users || 0;
                    document.getElementById('totalModules').textContent = stats.total_modules || 0;
                    document.getElementById('totalAssignments').textContent = stats.total_assignments || 0;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load users - filter only role 'user'
        async function loadUsers() {
            try {
                const response = await apiService.getAllUsers();
                if (response.success) {
                    const allUsersData = response.data.users || response.data || [];
                    // Filter only users with role 'user'
                    allUsers = allUsersData.filter(user => user.role === 'user');
                    calculateUserLevels();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Calculate user level statistics
        function calculateUserLevels() {
            const levels = {
                fundamental: 0,
                intermediate: 0,
                advance: 0,
                none: 0
            };

            allUsers.forEach(user => {
                if (user.level) {
                    levels[user.level] = (levels[user.level] || 0) + 1;
                } else {
                    levels.none++;
                }
            });

            document.getElementById('fundamentalUsers').textContent = levels.fundamental;
            document.getElementById('intermediateUsers').textContent = levels.intermediate;
            document.getElementById('advanceUsers').textContent = levels.advance;
            document.getElementById('noLevelUsers').textContent = levels.none;
        }

        // Load modules
        async function loadModules() {
            try {
                const response = await apiService.getAllModules();
                if (response.success) {
                    allModules = response.data.modules || response.data || [];
                    console.log('Loaded modules:', allModules);
                    populateModuleFilter();
                }
            } catch (error) {
                console.error('Error loading modules:', error);
            }
        }

        // Populate module filter
        function populateModuleFilter() {
            const select = document.getElementById('moduleFilterAssignments');
            if (select && allModules.length > 0) {
                const options = allModules.map(m =>
                    `<option value="${m.slug}">${m.name}</option>`
                ).join('');
                select.innerHTML = '<option value="">All Modules</option>' + options;
            }
        }

        // Load assignments
        async function loadAssignments() {
            try {
                const response = await apiService.getAllAssignments();
                if (response.success) {
                    allAssignments = response.data.assignments || response.data || [];
                    console.log('Loaded assignments:', allAssignments);

                    // Load submissions for each assignment
                    await loadAssignmentSubmissions();
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
            }
        }

        // Load assignment submissions
        async function loadAssignmentSubmissions() {
            for (const assignment of allAssignments) {
                try {
                    const response = await apiService.getAssignmentSubmissions(assignment.id);
                    if (response.success) {
                        assignmentSubmissions[assignment.id] = response.data || [];
                    }
                } catch (error) {
                    console.error(`Error loading submissions for assignment ${assignment.id}:`, error);
                    assignmentSubmissions[assignment.id] = [];
                }
            }
        }

        // Render all reports
        function renderAllReports() {
            renderModuleStats();
            renderAssignmentStats();
            renderUserActivity();
        }

        // Render module statistics
        function renderModuleStats() {
            const tbody = document.getElementById('moduleStatsTable');

            if (allModules.length === 0) {
                // Show dummy data
                const dummyModules = [
                    { name: 'Introduction to Programming', level: 'fundamental', enrollments: 45, active: 42, classes: 5, assignments: 8 },
                    { name: 'Data Structures & Algorithms', level: 'intermediate', enrollments: 32, active: 28, classes: 6, assignments: 10 },
                    { name: 'Advanced Web Development', level: 'advance', enrollments: 18, active: 15, classes: 4, assignments: 12 }
                ];

                tbody.innerHTML = `
                    <tr style="background-color: #fff9e6; border-left: 4px solid #f59e0b;">
                        <td colspan="6" style="text-align:center;padding:12px;">
                            <i class='bx bx-info-circle' style="color:#f59e0b;"></i>
                            <strong style="color:#f59e0b;"> Sample Data</strong> - No actual modules found. The data below is for demonstration purposes.
                        </td>
                    </tr>
                ` + dummyModules.map(module => `
                    <tr style="opacity: 0.7;">
                        <td><strong>${module.name}</strong></td>
                        <td><span class="badge badge-${getLevelColor(module.level)}">${module.level}</span></td>
                        <td>${module.enrollments}</td>
                        <td>${module.active}</td>
                        <td>${module.classes}</td>
                        <td>${module.assignments}</td>
                    </tr>
                `).join('');
                return;
            }

            tbody.innerHTML = allModules.map(module => {
                return `
                    <tr>
                        <td><strong>${module.name}</strong></td>
                        <td><span class="badge badge-${getLevelColor(module.level)}">${module.level}</span></td>
                        <td>${module.total_enrollments || 0}</td>
                        <td>${module.total_enrollments || 0}</td>
                        <td>${module.total_classes || 0}</td>
                        <td>${module.total_assignments || 0}</td>
                    </tr>
                `;
            }).join('');
        }

        // Render assignment statistics
        function renderAssignmentStats(moduleFilter = '') {
            const tbody = document.getElementById('assignmentStatsTable');
            const filtered = moduleFilter ?
                allAssignments.filter(a => a.module_slug === moduleFilter) :
                allAssignments;

            if (filtered.length === 0) {
                // Show dummy data
                const dummyAssignments = [
                    { title: 'Variables & Data Types Quiz', module: 'Introduction to Programming', submissions: 42, graded: 38, pending: 4, avgScore: 82.5, maxScore: 100 },
                    { title: 'Binary Search Implementation', module: 'Data Structures & Algorithms', submissions: 28, graded: 25, pending: 3, avgScore: 75.8, maxScore: 100 },
                    { title: 'REST API Development', module: 'Advanced Web Development', submissions: 15, graded: 12, pending: 3, avgScore: 88.3, maxScore: 100 },
                    { title: 'Sorting Algorithms Project', module: 'Data Structures & Algorithms', submissions: 30, graded: 30, pending: 0, avgScore: 79.2, maxScore: 100 }
                ];

                tbody.innerHTML = `
                    <tr style="background-color: #fff9e6; border-left: 4px solid #f59e0b;">
                        <td colspan="6" style="text-align:center;padding:12px;">
                            <i class='bx bx-info-circle' style="color:#f59e0b;"></i>
                            <strong style="color:#f59e0b;"> Sample Data</strong> - No actual assignments found. The data below is for demonstration purposes.
                        </td>
                    </tr>
                ` + dummyAssignments.map(assignment => `
                    <tr style="opacity: 0.7;">
                        <td><strong>${assignment.title}</strong></td>
                        <td>${assignment.module}</td>
                        <td>${assignment.submissions}</td>
                        <td><span class="badge badge-success">${assignment.graded}</span></td>
                        <td><span class="badge badge-warning">${assignment.pending}</span></td>
                        <td>${assignment.avgScore}/${assignment.maxScore}</td>
                    </tr>
                `).join('');
                return;
            }

            tbody.innerHTML = filtered.map(assignment => {
                const submissions = assignmentSubmissions[assignment.id] || [];
                const graded = submissions.filter(s => s.status === 'graded').length;
                const pending = submissions.filter(s => s.status === 'pending' || s.status === 'submitted').length;

                const scores = submissions.filter(s => s.score !== null).map(s => s.score);
                const avgScore = scores.length > 0 ?
                    (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) :
                    '-';

                return `
                    <tr>
                        <td><strong>${assignment.title}</strong></td>
                        <td>${assignment.module_name}</td>
                        <td>${submissions.length}</td>
                        <td><span class="badge badge-success">${graded}</span></td>
                        <td><span class="badge badge-warning">${pending}</span></td>
                        <td>${avgScore !== '-' ? avgScore + '/' + assignment.max_score : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Render user activity
        function renderUserActivity() {
            const tbody = document.getElementById('userActivityTable');

            if (allUsers.length === 0) {
                // Show dummy data
                const dummyUsers = [
                    { name: 'John Doe', email: 'john.doe@example.com', role: 'student', level: 'intermediate', pretestScore: 75, enrollments: 3, lastActive: '2025-11-08 14:30:00' },
                    { name: 'Jane Smith', email: 'jane.smith@example.com', role: 'student', level: 'fundamental', pretestScore: 65, enrollments: 2, lastActive: '2025-11-08 13:15:00' },
                    { name: 'Michael Johnson', email: 'michael.j@example.com', role: 'student', level: 'advance', pretestScore: 90, enrollments: 4, lastActive: '2025-11-08 11:45:00' },
                    { name: 'Sarah Williams', email: 'sarah.w@example.com', role: 'student', level: 'intermediate', pretestScore: 80, enrollments: 3, lastActive: '2025-11-08 10:20:00' },
                    { name: 'David Brown', email: 'david.b@example.com', role: 'student', level: 'fundamental', pretestScore: 70, enrollments: 2, lastActive: '2025-11-08 09:00:00' }
                ];

                tbody.innerHTML = `
                    <tr style="background-color: #fff9e6; border-left: 4px solid #f59e0b;">
                        <td colspan="7" style="text-align:center;padding:12px;">
                            <i class='bx bx-info-circle' style="color:#f59e0b;"></i>
                            <strong style="color:#f59e0b;"> Sample Data</strong> - No actual users found. The data below is for demonstration purposes.
                        </td>
                    </tr>
                ` + dummyUsers.map(user => `
                    <tr style="opacity: 0.7;">
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-info">${user.role}</span></td>
                        <td><span class="badge badge-${getLevelColor(user.level)}">${user.level}</span></td>
                        <td>${user.pretestScore}</td>
                        <td>${user.enrollments}</td>
                        <td>${user.lastActive}</td>
                    </tr>
                `).join('');
                return;
            }

            // Sort by created_at (most recent first)
            const sortedUsers = [...allUsers].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            tbody.innerHTML = sortedUsers.map(user => {
                // Use enrollment count from user object if available
                const enrollmentCount = user.enrollment_count || user.total_enrollments || 0;

                return `
                    <tr>
                        <td><strong>${user.name || 'N/A'}</strong></td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-info">${user.role}</span></td>
                        <td>${user.level ? `<span class="badge badge-${getLevelColor(user.level)}">${user.level}</span>` : '-'}</td>
                        <td>${user.pretest_score !== null ? user.pretest_score : '-'}</td>
                        <td>${enrollmentCount}</td>
                        <td>${new Date(user.created_at).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // Export user data to CSV
        function exportUserData() {
            const headers = ['Name', 'Email', 'Role', 'Level', 'Pretest Score', 'Status', 'Registered'];
            const rows = allUsers.map(user => [
                user.name || 'N/A',
                user.email,
                user.role,
                user.level || '-',
                user.pretest_score !== null ? user.pretest_score : '-',
                user.status,
                new Date(user.created_at).toLocaleDateString()
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `codesmart-users-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Helper functions
        function getLevelColor(level) {
            switch (level) {
                case 'fundamental': return 'success';
                case 'intermediate': return 'warning';
                case 'advance': return 'danger';
                default: return 'secondary';
            }
        }

        function logout() {
            modalService.confirm({
                title: '<i class=\'bx bx-log-out\'></i> Confirm Logout',
                message: 'Are you sure you want to logout from CodeSmart Admin Dashboard?',
                confirmText: 'Yes, Logout',
                cancelText: 'Cancel',
                danger: true,
                onConfirm: function() {
                    authService.logout();
                }
            });
        }

        // Set user info
        const currentUser = authService.getCurrentUser();
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name || 'Admin';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'A')[0].toUpperCase();
        }

        // Event listener for module filter
        document.getElementById('moduleFilterAssignments').addEventListener('change', function() {
            renderAssignmentStats(this.value);
        });

        // Add click handler for notification bell - make sure it works
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBell = document.querySelector('.notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Notification bell clicked');
                    if (typeof modalService !== 'undefined' && modalService.showNotifications) {
                        modalService.showNotifications();
                    } else {
                        console.error('modalService not found');
                    }
                });
                console.log('Notification bell event listener attached');
            }
        });

        // Add welcome notification after 1 second
        setTimeout(() => {
            modalService.addNotification({
                title: 'Welcome to Reports & Analytics',
                message: 'View comprehensive reports and insights about student performance',
                type: 'success'
            });
        }, 1000);

        // Add sample notifications for demo
        setTimeout(() => {
            modalService.addNotification({
                title: 'Report Generated',
                message: 'Monthly performance report is ready to download',
                type: 'info'
            });
        }, 2500);

        // Initialize
        loadAllData();

        // ========================================
        // SVM Analytics Functions
        // ========================================
        let svmPredictionsData = [];

        // Load SVM data
        async function loadSVMData() {
            try {
                const response = await apiService.fetchWithAuth('/ml/stats');

                if (response.success && response.data.statistics.total_predictions > 0) {
                    const stats = response.data.statistics;
                    const predictions = response.data.predictions || [];

                    // Update stats grid
                    const statsHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${stats.total_predictions}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Total Predictions</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #fa709a;">${stats.fundamental_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Fundamental</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #4facfe;">${stats.intermediate_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Intermediate</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #43e97b;">${stats.advance_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Advance</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #10b981;">${stats.matching_predictions}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Matching</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #667eea;">${(stats.avg_confidence || 0).toFixed(1)}%</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Avg Confidence</div>
                        </div>
                    `;
                    document.getElementById('svmStatsGrid').innerHTML = statsHTML;

                    // Render table
                    renderSVMTable(predictions);
                    svmPredictionsData = predictions;

                    // Show table
                    document.getElementById('svmTableContainer').style.display = 'block';
                    document.getElementById('svmEmptyState').style.display = 'none';
                } else {
                    showSVMEmptyState();
                }
            } catch (error) {
                console.error('Error loading SVM data:', error);
                showSVMEmptyState();
            }
        }

        // Render SVM table
        function renderSVMTable(predictions) {
            const tbody = document.getElementById('svmPredictionsBody');
            tbody.innerHTML = '';

            predictions.slice(0, 10).forEach(pred => {
                const match = pred.current_level === pred.svm_predicted_level;
                const matchText = match ? '✅ Match' : '❌ Different';
                const matchColor = match ? '#10b981' : '#ef4444';

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e5e7eb';
                row.innerHTML = `
                    <td style="padding: 12px; font-size: 13px;"><strong>${pred.name || 'Unknown'}</strong></td>
                    <td style="padding: 12px; font-size: 13px;">${pred.pretest_score || 0}</td>
                    <td style="padding: 12px; font-size: 13px;"><span style="padding: 4px 8px; border-radius: 6px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-size: 11px; font-weight: 600;">${pred.current_level || '-'}</span></td>
                    <td style="padding: 12px; font-size: 13px;"><span style="padding: 4px 8px; border-radius: 6px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; font-size: 11px; font-weight: 600;">${pred.svm_predicted_level || '-'}</span></td>
                    <td style="padding: 12px; font-size: 13px;">
                        <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${pred.svm_confidence || 0}%; height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                        </div>
                        <div style="font-size: 11px; color: #718096; margin-top: 4px;">${(pred.svm_confidence || 0).toFixed(1)}%</div>
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: ${matchColor}; font-weight: 600;">${matchText}</td>
                    <td style="padding: 12px; font-size: 13px; color: #6b7280;">${pred.prediction_date ? new Date(pred.prediction_date).toLocaleDateString() : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Run SVM batch prediction
        async function runSVMBatchPrediction() {
            if (!confirm('Run batch prediction untuk semua siswa dengan pretest?')) return;

            try {
                document.getElementById('svmStatsGrid').innerHTML = '<div style="text-align: center; padding: 20px;"><i class="bx bx-loader-alt bx-spin" style="font-size: 32px; color: #667eea;"></i><p style="margin-top: 12px; color: #6b7280;">Running batch prediction...</p></div>';

                const response = await apiService.fetchWithAuth('/ml/batch-predict', { method: 'POST' });

                if (response.success) {
                    alert(`✅ Batch prediction berhasil!\n\nTotal: ${response.data.total_users}\nSuccess: ${response.data.successful_predictions}\nFailed: ${response.data.failed_predictions}`);
                    loadSVMData();
                } else {
                    alert('❌ Batch prediction gagal: ' + (response.error || 'Unknown error'));
                    showSVMEmptyState();
                }
            } catch (error) {
                console.error('Error running batch prediction:', error);
                alert('❌ Error: ' + error.message);
                showSVMEmptyState();
            }
        }

        // Show empty state
        function showSVMEmptyState() {
            document.getElementById('svmStatsGrid').innerHTML = '';
            document.getElementById('svmTableContainer').style.display = 'none';
            document.getElementById('svmEmptyState').style.display = 'block';
        }

        // Load SVM data on page load
        setTimeout(() => {
            loadSVMData();
        }, 1500);
    </script>
</body>
</html>
