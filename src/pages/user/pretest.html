<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#754ef9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CodeSmart">

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/src/images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/src/images/icon-192x192.png">

    <title>Pretest - CodeSmart</title>

    <!-- box icons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- custom css -->
    <link rel="stylesheet" href="../../css/index.css">

    <style>
        .pretest-container {
            min-height: 100vh;
            padding: 10rem 7% 2rem;
        }

        .pretest-header {
            text-align: center;
            margin-bottom: 4rem;
        }

        .pretest-header h1 {
            font-size: 4rem;
            color: var(--main-color);
            margin-bottom: 1rem;
        }

        .pretest-header p {
            font-size: 1.6rem;
            color: var(--text-color);
        }

        .pretest-info {
            background: var(--bg-color);
            padding: 3rem;
            border-radius: 2rem;
            box-shadow: 0 .5rem 2rem var(--shadow-color);
            margin-bottom: 3rem;
            border-left: .6rem solid var(--main-color);
        }

        .pretest-info h3 {
            font-size: 2.2rem;
            margin-bottom: 1.5rem;
            color: var(--main-color);
        }

        .pretest-info ul {
            list-style: none;
            font-size: 1.6rem;
        }

        .pretest-info li {
            padding: .8rem 0;
            padding-left: 3rem;
            position: relative;
        }

        .pretest-info li:before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: var(--main-color);
            font-weight: bold;
            font-size: 2rem;
        }

        .question-container {
            background: var(--bg-color);
            padding: 3rem;
            border-radius: 2rem;
            box-shadow: 0 .5rem 2rem var(--shadow-color);
            margin-bottom: 3rem;
            border-top: .6rem solid var(--main-color);
            display: none;
        }

        .question-container.active {
            display: block;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .question-number {
            font-size: 1.8rem;
            color: var(--main-color);
            font-weight: 600;
        }

        .question-progress {
            font-size: 1.4rem;
            color: var(--text-color);
        }

        .question-text {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .option {
            padding: 1.5rem 2rem;
            border: .2rem solid var(--main-color);
            border-radius: 1rem;
            font-size: 1.6rem;
            cursor: pointer;
            transition: .3s ease;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .option:hover {
            background: var(--main-color);
            color: var(--white-color);
            transform: translateX(1rem);
        }

        .option.selected {
            background: var(--main-color);
            color: var(--white-color);
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            gap: 2rem;
        }

        .btn-nav {
            padding: 1.5rem 3rem;
            font-size: 1.6rem;
            border-radius: .8rem;
            cursor: pointer;
            font-weight: 600;
            transition: .5s ease;
        }

        .btn-prev {
            background: transparent;
            color: var(--main-color);
            border: .2rem solid var(--main-color);
        }

        .btn-prev:hover:not(:disabled) {
            background: var(--main-color);
            color: var(--white-color);
        }

        .btn-next,
        .btn-finish {
            background: var(--main-color);
            color: var(--white-color);
            border: .2rem solid var(--main-color);
        }

        .btn-next:hover,
        .btn-finish:hover {
            background: transparent;
            color: var(--main-color);
        }

        .btn-nav:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        .btn-start {
            display: inline-block;
            padding: 1.5rem 4rem;
            background: var(--main-color);
            border-radius: .8rem;
            font-size: 1.8rem;
            color: var(--white-color);
            font-weight: 600;
            border: .2rem solid transparent;
            transition: .5s ease;
            cursor: pointer;
            margin-top: 2rem;
        }

        .btn-start:hover {
            background: transparent;
            color: var(--main-color);
            border-color: var(--main-color);
        }

        .results-container {
            display: none;
            background: var(--bg-color);
            padding: 4rem;
            border-radius: 2rem;
            box-shadow: 0 .5rem 2rem var(--shadow-color);
            text-align: center;
            border-top: .6rem solid var(--main-color);
        }

        .results-container.active {
            display: block;
        }

        .score-display {
            font-size: 6rem;
            color: var(--main-color);
            font-weight: 700;
            margin: 2rem 0;
        }

        .recommendation {
            background: rgba(117, 78, 249, 0.1);
            padding: 2rem;
            border-radius: 1rem;
            margin: 2rem 0;
        }

        .recommendation h3 {
            font-size: 2.4rem;
            color: var(--main-color);
            margin-bottom: 1rem;
        }

        .recommendation p {
            font-size: 1.6rem;
            color: var(--text-color);
        }

        .analysis {
            text-align: left;
            margin: 3rem 0;
        }

        .analysis h4 {
            font-size: 2rem;
            color: var(--main-color);
            margin-bottom: 1.5rem;
        }

        .analysis-item {
            padding: 1rem 0;
            font-size: 1.6rem;
        }

        .logout-btn {
            position: fixed;
            top: 2rem;
            right: 7%;
            font-size: 1.6rem;
            padding: 1rem 2rem;
            background: transparent;
            color: var(--main-color);
            border: .2rem solid var(--main-color);
            border-radius: .8rem;
            cursor: pointer;
            transition: .3s ease;
        }

        .logout-btn:hover {
            background: var(--main-color);
            color: var(--white-color);
        }
    </style>
</head>

<body>
    <button class="logout-btn" onclick="authService.logout()">
        <i class='bx bx-log-out'></i> Logout
    </button>

    <section class="pretest-container">
        <!-- Welcome Info -->
        <div id="welcomeSection">
            <div class="pretest-header">
                <h1>Selamat Datang di Pretest</h1>
                <p>Tentukan Level Pembelajaran JavaScript Anda</p>
            </div>

            <div class="pretest-info">
                <h3>Informasi Pretest</h3>
                <ul>
                    <li>Total pertanyaan: <strong>10 soal</strong></li>
                    <li>Durasi: <strong>Tidak dibatasi</strong></li>
                    <li>Sistem penilaian menggunakan metode <strong>SVM (Support Vector Machine)</strong></li>
                    <li>Hasil akan menentukan modul rekomendasi Anda</li>
                </ul>

                <h3 style="margin-top: 2rem;">Level Modul Berdasarkan Score:</h3>
                <ul>
                    <li><strong>0-45:</strong> Fundamental JavaScript</li>
                    <li><strong>46-65:</strong> Intermediate JavaScript</li>
                    <li><strong>66-100:</strong> Advance JavaScript</li>
                </ul>

                <div style="text-align: center;">
                    <button class="btn-start" onclick="startPretest()">Mulai Pretest</button>
                </div>
            </div>
        </div>

        <!-- Question Section -->
        <div id="questionSection" style="display: none;">
            <div class="pretest-header">
                <h1>Pretest JavaScript</h1>
                <p id="userGreeting"></p>
            </div>

            <div id="questionsContainer"></div>

            <div class="navigation-buttons">
                <button class="btn-nav btn-prev" onclick="previousQuestion()" id="btnPrev" disabled>
                    <i class='bx bx-chevron-left'></i> Sebelumnya
                </button>
                <button class="btn-nav btn-next" onclick="nextQuestion()" id="btnNext">
                    Selanjutnya <i class='bx bx-chevron-right'></i>
                </button>
                <button class="btn-nav btn-finish" onclick="finishPretest()" id="btnFinish" style="display: none;">
                    Selesai <i class='bx bx-check'></i>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-container">
            <h2 style="font-size: 3rem; color: var(--main-color);">Hasil Pretest Anda</h2>
            <div class="score-display" id="scoreDisplay">0</div>
            <p style="font-size: 1.8rem;">dari 100</p>

            <div class="recommendation">
                <h3 id="recommendationTitle">Modul Rekomendasi</h3>
                <p id="recommendationMessage"></p>
            </div>

            <div class="analysis">
                <h4>Detail Hasil:</h4>
                <div id="analysisDetails"></div>
            </div>

            <button class="btn-start" onclick="goToDashboard()">
                Lanjut ke Dashboard <i class='bx bx-arrow-right'></i>
            </button>
        </div>
    </section>

    <!-- Load database and auth -->
    <script src="../../data/database.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/svm.js"></script>

    <script>
        // Check authentication
        if (!authService.requireAuth()) {
            window.location.href = '/index.html';
        }

        const currentUser = authService.getCurrentUser();

        // Redirect if already completed pretest
        if (currentUser && currentUser.pretestCompleted) {
            window.location.href = 'dashboard.html';
        }

        document.getElementById('userGreeting').textContent = `Halo, ${currentUser.name}!`;

        let currentQuestionIndex = 0;
        let userAnswers = [];
        const questions = Database.pretestQuestions;

        function startPretest() {
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('questionSection').style.display = 'block';
            loadQuestions();
            showQuestion(0);
        }

        function loadQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.id = `question-${index}`;

                questionDiv.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Pertanyaan ${index + 1}</div>
                        <div class="question-progress">${index + 1} dari ${questions.length}</div>
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="options" id="options-${index}">
                        ${question.options.map((option, optIndex) => `
                            <div class="option" onclick="selectOption(${index}, ${optIndex})">
                                ${String.fromCharCode(65 + optIndex)}. ${option}
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(questionDiv);
            });
        }

        function showQuestion(index) {
            document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
            document.getElementById(`question-${index}`).classList.add('active');

            // Update buttons
            document.getElementById('btnPrev').disabled = index === 0;

            if (index === questions.length - 1) {
                document.getElementById('btnNext').style.display = 'none';
                document.getElementById('btnFinish').style.display = 'block';
            } else {
                document.getElementById('btnNext').style.display = 'block';
                document.getElementById('btnFinish').style.display = 'none';
            }

            // Restore selected answer if exists
            if (userAnswers[index] !== undefined) {
                const options = document.querySelectorAll(`#options-${index} .option`);
                options[userAnswers[index]].classList.add('selected');
            }

            currentQuestionIndex = index;
        }

        function selectOption(questionIndex, optionIndex) {
            // Remove previous selection
            document.querySelectorAll(`#options-${questionIndex} .option`).forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selection to clicked option
            event.target.classList.add('selected');

            // Save answer
            userAnswers[questionIndex] = optionIndex;
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        }

        function finishPretest() {
            // Check if all questions are answered
            if (userAnswers.length < questions.length) {
                alert('Harap jawab semua pertanyaan terlebih dahulu!');
                return;
            }

            // Calculate results using SVM
            const results = svmRecommendation.analyzeResults(userAnswers, questions);

            // Update user data
            authService.updateCurrentUser({
                pretestScore: results.score,
                recommendedModule: results.recommendation.level,
                pretestCompleted: true
            });

            // Display results
            displayResults(results);
        }

        function displayResults(results) {
            document.getElementById('questionSection').style.display = 'none';
            document.getElementById('resultsSection').classList.add('active');

            // Animate score
            animateScore(results.score);

            document.getElementById('recommendationTitle').textContent = results.recommendation.moduleName;
            document.getElementById('recommendationMessage').textContent = results.recommendation.message;

            // Display analysis
            const analysisDiv = document.getElementById('analysisDetails');
            analysisDiv.innerHTML = `
                <div class="analysis-item">
                    <strong>Total Pertanyaan:</strong> ${results.totalQuestions}
                </div>
                <div class="analysis-item">
                    <strong>Jawaban Benar:</strong> ${results.correctAnswers}
                </div>
                <div class="analysis-item">
                    <strong>Level Rekomendasi:</strong> ${results.recommendation.level.toUpperCase()}
                </div>
                <div class="analysis-item">
                    <strong>Modul yang Terbuka:</strong> ${results.recommendation.moduleName}
                </div>
                ${results.strengths.length > 0 ? `
                    <div class="analysis-item">
                        <strong>Kekuatan:</strong>
                        <ul style="margin-top: 0.5rem;">
                            ${results.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${results.weaknesses.length > 0 ? `
                    <div class="analysis-item">
                        <strong>Area Pengembangan:</strong>
                        <ul style="margin-top: 0.5rem;">
                            ${results.weaknesses.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        function animateScore(targetScore) {
            let currentScore = 0;
            const increment = targetScore / 50;
            const timer = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(timer);
                }
                document.getElementById('scoreDisplay').textContent = Math.round(currentScore);
            }, 20);
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        // Dark mode
        const savedMode = localStorage.getItem('darkMode');
        if (savedMode === 'enabled') {
            document.body.classList.add('dark-mode');
        }
    </script>

    <!-- PWA js -->
    <script src="/src/js/pwa.js"></script>
</body>

</html>
