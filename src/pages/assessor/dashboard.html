<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#754ef9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CodeSmart">

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/src/images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/src/images/icon-192x192.png">

    <title>Assessor Dashboard - LMS Management - CodeSmart</title>

    <!-- box icons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- custom css -->
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="stylesheet" href="../../css/pwa.css">
    <link rel="stylesheet" href="../../css/lms.css">

    <style>
        :root {
            --bg-color: #fdfdfd;
            --text-color: #333;
            --main-color: #754ef9;
            --white-color: #fdfdfd;
            --shadow-color: rgba(0, 0, 0, .2);
            --sidebar-width: 260px;
            --header-height: 70px;
        }

        .dark-mode {
            --bg-color: #0b061f;
            --text-color: #fdfdfd;
            --shadow-color: rgba(0, 0, 0, .7);
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            transition: .3s;
        }

        /* Header */
        .dashboard-header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--bg-color);
            box-shadow: 0 .2rem 1rem var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 3rem;
            z-index: 99;
            transition: left .3s ease;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .menu-toggle {
            font-size: 2.4rem;
            color: var(--text-color);
            cursor: pointer;
            display: none;
        }

        .page-title-header {
            font-size: 2rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .dark-mode-toggle {
            font-size: 2.4rem;
            color: var(--text-color);
            cursor: pointer;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            position: relative;
        }

        .user-avatar {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: var(--main-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white-color);
            font-size: 1.6rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .user-role {
            font-size: 1.2rem;
            color: var(--main-color);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--main-color);
            padding: 2rem 0;
            z-index: 100;
            transition: left .3s ease;
            overflow-y: auto;
        }

        .sidebar-logo {
            padding: 0 2rem;
            margin-bottom: 3rem;
        }

        .sidebar-logo h2 {
            font-size: 2.5rem;
            color: var(--white-color);
            font-weight: 700;
        }

        .sidebar-logo p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
        }

        .sidebar-menu {
            list-style: none;
        }

        .menu-item {
            margin-bottom: .5rem;
        }

        .menu-link {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.5rem;
            transition: .3s ease;
            cursor: pointer;
        }

        .menu-link:hover,
        .menu-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white-color);
            border-left: .4rem solid var(--white-color);
        }

        .menu-link i {
            font-size: 2rem;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 3rem;
            min-height: calc(100vh - var(--header-height));
            transition: margin-left .3s ease;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .assessor-header {
            background: linear-gradient(135deg, #754ef9, #9d7bea);
            color: white;
            padding: 3rem;
            border-radius: 1.5rem;
            margin-bottom: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assessor-header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .assessor-header .breadcrumb {
            font-size: 1.4rem;
            opacity: 0.9;
        }

        .assessor-header .breadcrumb a {
            color: white;
            text-decoration: none;
        }

        .assessor-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .module-selector {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .module-card {
            flex: 1;
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 0.5rem 1.5rem var(--shadow-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.8rem 2rem var(--shadow-color);
        }

        .module-card.active {
            border-color: var(--main-color);
            background: linear-gradient(135deg, rgba(117, 78, 249, 0.1), rgba(157, 123, 234, 0.1));
        }

        .module-card h3 {
            font-size: 2rem;
            margin-bottom: 0.8rem;
            color: var(--text-color);
        }

        .module-card .module-level {
            display: inline-block;
            padding: 0.5rem 1.2rem;
            border-radius: 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .module-card.fundamental .module-level {
            background: #d1fae5;
            color: #065f46;
        }

        .module-card.intermediate .module-level {
            background: #fef3c7;
            color: #92400e;
        }

        .module-card.advance .module-level {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-row {
            display: flex;
            gap: 1rem;
            font-size: 1.3rem;
            color: #666;
        }

        .stats-row span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .manage-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .manage-tab {
            padding: 2rem;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 0.5rem 1.5rem var(--shadow-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 3px solid transparent;
        }

        .manage-tab:hover {
            transform: translateY(-3px);
        }

        .manage-tab.active {
            border-color: var(--main-color);
            background: linear-gradient(135deg, rgba(117, 78, 249, 0.1), rgba(157, 123, 234, 0.1));
        }

        .manage-tab i {
            font-size: 3.5rem;
            color: var(--main-color);
            margin-bottom: 1rem;
        }

        .manage-tab .tab-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .manage-tab .tab-count {
            font-size: 1.2rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .logout-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            background: white;
            color: var(--main-color);
            border: 2px solid var(--main-color);
            border-radius: 1rem;
            font-size: 1.4rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .logout-btn:hover {
            background: var(--main-color);
            color: white;
        }

        @media (max-width: 768px) {
            .module-selector {
                flex-direction: column;
            }

            .manage-tabs {
                grid-template-columns: repeat(2, 1fr);
            }

            .assessor-header {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }

            .logout-btn {
                position: static;
                width: 100%;
                margin-bottom: 2rem;
                justify-content: center;
            }
        }

        /* Sidebar Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                left: calc(-1 * var(--sidebar-width));
            }

            .sidebar.active {
                left: 0;
                box-shadow: 0.5rem 0 2rem rgba(0, 0, 0, 0.5);
            }

            .dashboard-header {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block !important;
            }

            .module-selector {
                flex-direction: column;
            }

            .manage-tabs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            :root {
                font-size: 55%;
            }

            .manage-tabs {
                grid-template-columns: 1fr;
            }

            .assessor-header {
                flex-direction: column;
                text-align: center;
            }

            .assessor-header h1 {
                font-size: 2.4rem;
            }

            .main-content {
                padding: 1.5rem;
            }

            .dashboard-header {
                padding: 0 1.5rem;
            }

            .page-title-header {
                font-size: 1.6rem;
            }

            .user-info {
                display: none;
            }
        }

        /* Sidebar scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 0.5rem;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- PWA Loading Splash Screen -->
    <div class="pwa-loading" id="pwaLoading">
        <div class="pwa-loading-logo">
            <i class='bx bx-code-alt'></i> CodeSmart
        </div>
        <div class="pwa-loading-spinner"></div>
        <p class="pwa-loading-text">Loading Assessor Dashboard...</p>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h2><i class='bx bx-code-alt'></i> CodeSmart</h2>
            <p>Assessor Dashboard</p>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="#" class="menu-link active" data-tab="lms">
                    <i class='bx bx-chalkboard'></i>
                    <span>LMS Management</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-tab="profile">
                    <i class='bx bx-user-circle'></i>
                    <span>Profile</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" data-tab="settings">
                    <i class='bx bx-cog'></i>
                    <span>Settings</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#" class="menu-link" onclick="logout(); return false;">
                    <i class='bx bx-log-out'></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <i class='bx bx-menu menu-toggle' id="menuToggle"></i>
            <h1 class="page-title-header" id="pageTitle">LMS Management</h1>
        </div>
        <div class="header-right">
            <i class='bx bx-moon dark-mode-toggle' id="darkModeToggle"></i>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Assessor</div>
                    <div class="user-role">Assessor</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- LMS Management Tab -->
        <div id="lmsTab" class="tab-content active">
            <div class="assessor-container">
                <!-- Header Banner -->
                <div class="assessor-header">
            <div>
                <div class="breadcrumb">
                    <a href="../../index.html"><i class='bx bx-home'></i> Home</a> / Assessor Dashboard
                </div>
                <h1><i class='bx bx-chalkboard'></i> LMS Management System</h1>
                <p style="margin-top: 0.8rem; font-size: 1.5rem;">Kelola pembelajaran, tugas, nilai, dan monitor progress siswa</p>
            </div>
            <div>
                <i class='bx bx-book-reader' style="font-size: 8rem; opacity: 0.3;"></i>
            </div>
        </div>

        <!-- Module Selector -->
        <div class="module-selector" id="moduleSelector">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Management Tabs -->
        <div class="manage-tabs">
            <div class="manage-tab active" data-view="classes" onclick="switchTab('classes')">
                <i class='bx bx-book-open'></i>
                <div class="tab-title">Kelas</div>
                <div class="tab-count" id="classesCount">0 kelas</div>
            </div>
            <div class="manage-tab" data-view="assignments" onclick="switchTab('assignments')">
                <i class='bx bx-task'></i>
                <div class="tab-title">Tugas</div>
                <div class="tab-count" id="assignmentsCount">0 tugas</div>
            </div>
            <div class="manage-tab" data-view="submissions" onclick="switchTab('submissions')">
                <i class='bx bx-file-find'></i>
                <div class="tab-title">Pengumpulan</div>
                <div class="tab-count" id="submissionsCount">0 pending</div>
            </div>
            <div class="manage-tab" data-view="students" onclick="switchTab('students')">
                <i class='bx bx-group'></i>
                <div class="tab-title">Siswa</div>
                <div class="tab-count" id="studentsCount">0 siswa</div>
            </div>
            <div class="manage-tab" data-view="promotions" onclick="switchTab('promotions')">
                <i class='bx bx-trophy'></i>
                <div class="tab-title">Naik Tingkat</div>
                <div class="tab-count" id="promotionsCount">0 pending</div>
            </div>
            <div class="manage-tab" data-view="reports" onclick="switchTab('reports')">
                <i class='bx bx-bar-chart-alt-2'></i>
                <div class="tab-title">Laporan</div>
                <div class="tab-count">Report</div>
            </div>
            <div class="manage-tab" data-view="export" onclick="switchTab('export')">
                <i class='bx bx-export'></i>
                <div class="tab-title">Export/Import</div>
                <div class="tab-count">Data</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div style="background: white; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 0.5rem 1.5rem var(--shadow-color);">

            <!-- View: Classes -->
            <div id="classesView" class="manage-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2.4rem;"><i class='bx bx-book-open'></i> Kelas dalam Modul</h2>
                </div>
                <div id="classesList"></div>
            </div>

            <!-- View: Assignments -->
            <div id="assignmentsView" class="manage-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2.4rem;"><i class='bx bx-task'></i> Manajemen Tugas</h2>
                    <button class="btn-lms btn-primary" onclick="openAddAssignmentModal()">
                        <i class='bx bx-plus'></i> Tambah Tugas Baru
                    </button>
                </div>
                <div id="assignmentsList"></div>
            </div>

            <!-- View: Submissions -->
            <div id="submissionsView" class="manage-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2.4rem;"><i class='bx bx-file-find'></i> Pengumpulan Tugas</h2>
                    <div style="display: flex; gap: 1rem;">
                        <select id="filterAssignment" onchange="loadSubmissions()" style="padding: 1rem; border-radius: 0.8rem; border: 2px solid #e0e0e0; font-size: 1.4rem;">
                            <option value="">Semua Tugas</option>
                        </select>
                        <select id="filterStatus" onchange="loadSubmissions()" style="padding: 1rem; border-radius: 0.8rem; border: 2px solid #e0e0e0; font-size: 1.4rem;">
                            <option value="">Semua Status</option>
                            <option value="pending">Belum Dinilai</option>
                            <option value="graded">Sudah Dinilai</option>
                        </select>
                    </div>
                </div>
                <div id="submissionsList"></div>
            </div>

            <!-- View: Students -->
            <div id="studentsView" class="manage-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2.4rem;"><i class='bx bx-group'></i> Daftar Siswa per Kelas</h2>
                    <select id="filterClass" onchange="loadStudentsByClass()" style="padding: 1rem; border-radius: 0.8rem; border: 2px solid #e0e0e0; font-size: 1.4rem;">
                        <option value="">Pilih Kelas</option>
                    </select>
                </div>
                <div id="studentsList"></div>
            </div>

            <!-- View: Promotions -->
            <div id="promotionsView" class="manage-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2.4rem;"><i class='bx bx-trophy'></i> Permintaan Naik Tingkat</h2>
                    <button class="btn-lms" onclick="loadPromotions()" style="background: #10b981;">
                        <i class='bx bx-refresh'></i> Refresh
                    </button>
                </div>
                <div id="promotionsList"></div>
            </div>

            <!-- View: Reports -->
            <div id="reportsView" class="manage-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                    <h2 style="font-size: 2.4rem;"><i class='bx bx-bar-chart-alt-2'></i> Laporan Belajar Siswa</h2>
                    <select id="selectStudent" onchange="loadStudentReport()" style="padding: 1rem; border-radius: 0.8rem; border: 2px solid #e0e0e0; font-size: 1.4rem; min-width: 250px;">
                        <option value="">Pilih Siswa</option>
                    </select>
                </div>
                <div id="reportContent"></div>
            </div>

            <!-- View: Export/Import -->
            <div id="exportView" class="manage-view" style="display: none;">
                <h2 style="font-size: 2.4rem; margin-bottom: 2.5rem;"><i class='bx bx-export'></i> Export & Import Data</h2>

                <!-- Export Section -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 2.5rem; border-radius: 1.2rem; margin-bottom: 3rem; border: 2px solid #10b981;">
                    <h3 style="font-size: 2rem; margin-bottom: 1.5rem; color: #065f46;"><i class='bx bx-download'></i> Export Data</h3>
                    <p style="margin-bottom: 2rem; font-size: 1.4rem; color: #064e3b;">Download data LMS untuk backup atau analisis</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
                        <button onclick="ExportImport.exportAssignments()" style="padding: 1.5rem; background: #10b981; color: white; border: none; border-radius: 0.8rem; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 1rem; justify-content: center;">
                            <i class='bx bx-task' style="font-size: 2rem;"></i>
                            <span>Export Tugas</span>
                        </button>
                        <button onclick="ExportImport.exportSubmissions()" style="padding: 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.8rem; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 1rem; justify-content: center;">
                            <i class='bx bx-file' style="font-size: 2rem;"></i>
                            <span>Export Pengumpulan (JSON)</span>
                        </button>
                        <button onclick="ExportImport.exportSubmissionsCSV()" style="padding: 1.5rem; background: #06b6d4; color: white; border: none; border-radius: 0.8rem; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 1rem; justify-content: center;">
                            <i class='bx bx-spreadsheet' style="font-size: 2rem;"></i>
                            <span>Export Pengumpulan (CSV)</span>
                        </button>
                        <button onclick="ExportImport.exportLMSData()" style="padding: 1.5rem; background: #8b5cf6; color: white; border: none; border-radius: 0.8rem; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 1rem; justify-content: center;">
                            <i class='bx bx-book' style="font-size: 2rem;"></i>
                            <span>Export LMS Lengkap</span>
                        </button>
                    </div>
                </div>

                <!-- Import Section -->
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); padding: 2.5rem; border-radius: 1.2rem; border: 2px solid #3b82f6;">
                    <h3 style="font-size: 2rem; margin-bottom: 1.5rem; color: #1e3a8a;"><i class='bx bx-upload'></i> Import Data</h3>
                    <p style="margin-bottom: 2rem; font-size: 1.4rem; color: #1e40af;">Upload file JSON untuk restore data LMS</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
                        <button onclick="ExportImport.importLMSData()" style="padding: 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.8rem; font-size: 1.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 1rem; justify-content: center;">
                            <i class='bx bx-import' style="font-size: 2rem;"></i>
                            <span>Import LMS Data</span>
                        </button>
                    </div>

                    <!-- Warning Box -->
                    <div style="margin-top: 2.5rem; padding: 1.8rem; background: #fef3c7; border-radius: 0.8rem; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <i class='bx bx-error' style="font-size: 2.4rem; color: #92400e;"></i>
                            <div>
                                <strong style="color: #92400e; font-size: 1.5rem;">⚠️ Perhatian!</strong>
                                <ul style="color: #92400e; font-size: 1.3rem; margin-top: 0.8rem; padding-left: 2rem;">
                                    <li>Import akan merge dengan data yang sudah ada</li>
                                    <li>Data duplikat akan di-skip</li>
                                    <li>Selalu backup data sebelum import!</li>
                                    <li>Format file harus JSON yang valid</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(219, 39, 119, 0.1)); border-radius: 1.2rem; border: 2px solid #ec4899;">
                    <h4 style="font-size: 1.8rem; margin-bottom: 1.5rem; color: #831843;"><i class='bx bx-info-circle'></i> Data Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                        <div style="text-align: center; padding: 1.5rem;">
                            <div style="font-size: 3rem; font-weight: 700; color: #ec4899;" id="exportStatAssignments">0</div>
                            <div style="font-size: 1.3rem; color: #831843;">Total Tugas</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem;">
                            <div style="font-size: 3rem; font-weight: 700; color: #3b82f6;" id="exportStatSubmissions">0</div>
                            <div style="font-size: 1.3rem; color: #1e3a8a;">Total Pengumpulan</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem;">
                            <div style="font-size: 3rem; font-weight: 700; color: #10b981;" id="exportStatEnrollments">0</div>
                            <div style="font-size: 1.3rem; color: #065f46;">Total Enrollments</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem;">
                            <div style="font-size: 3rem; font-weight: 700; color: #f59e0b;" id="exportStatModules">3</div>
                            <div style="font-size: 1.3rem; color: #92400e;">Total Modul</div>
                        </div>
                    </div>
                </div>
            </div>

            </div>
        </div>
        <!-- End LMS Management Tab -->

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content">
            <div class="assessor-container">
                <div style="background: white; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 0.5rem 1.5rem var(--shadow-color);">
                    <h2 style="font-size: 2.4rem; margin-bottom: 2rem; color: var(--main-color);">
                        <i class='bx bx-user-circle'></i> Profile Settings
                    </h2>

                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div style="display: grid; gap: 2rem;">
                            <!-- Profile Photo Upload -->
                            <div style="text-align: center; padding: 2rem; background: #f9fafb; border-radius: 1rem;">
                                <label style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; display: block;">Profile Photo</label>
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 1.5rem;">
                                    <img id="profilePhotoPreview"
                                         src=""
                                         alt="Profile Photo"
                                         style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 0.4rem solid var(--main-color); box-shadow: 0 0.5rem 1.5rem var(--shadow-color);">
                                    <label for="profilePhotoInput" style="padding: 1rem 2rem; font-size: 1.4rem; border-radius: 0.8rem; border: none; background: var(--main-color); color: white; cursor: pointer; font-weight: 600; display: inline-block;">
                                        <i class='bx bx-upload'></i> Upload Photo
                                    </label>
                                    <input type="file"
                                           id="profilePhotoInput"
                                           accept="image/*"
                                           style="display: none;"
                                           onchange="handleProfilePhotoUpload(this)">
                                    <small style="color: #6b7280; font-size: 1.2rem;">Max 2MB (JPG, PNG, GIF, WEBP)</small>
                                </div>
                            </div>

                            <div>
                                <label style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.8rem; display: block;">Nama *</label>
                                <input type="text" id="profileName" style="width: 100%; padding: 1.2rem; font-size: 1.5rem; border-radius: 0.8rem; border: 0.2rem solid #e5e7eb;" required>
                            </div>
                            <div>
                                <label style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.8rem; display: block;">Email *</label>
                                <input type="email" id="profileEmail" style="width: 100%; padding: 1.2rem; font-size: 1.5rem; border-radius: 0.8rem; border: 0.2rem solid #e5e7eb;" required>
                            </div>
                            <div>
                                <label style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.8rem; display: block;">Phone Number</label>
                                <input type="tel" id="profilePhone" placeholder="08123456789 or +628123456789" style="width: 100%; padding: 1.2rem; font-size: 1.5rem; border-radius: 0.8rem; border: 0.2rem solid #e5e7eb;">
                                <small id="phoneError" style="color: #e74c3c; display: none; font-size: 1.2rem; margin-top: 0.5rem;"></small>
                            </div>
                            <div>
                                <label style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.8rem; display: block;">Username</label>
                                <input type="text" id="profileUsername" style="width: 100%; padding: 1.2rem; font-size: 1.5rem; border-radius: 0.8rem; border: 0.2rem solid #e5e7eb; background: #f3f4f6;" readonly>
                            </div>
                            <div>
                                <label style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.8rem; display: block;">Role</label>
                                <input type="text" id="profileRole" style="width: 100%; padding: 1.2rem; font-size: 1.5rem; border-radius: 0.8rem; border: 0.2rem solid #e5e7eb; background: #f3f4f6;" readonly>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="submit" style="padding: 1.2rem 2.5rem; font-size: 1.5rem; border-radius: 0.8rem; border: none; background: var(--main-color); color: white; cursor: pointer; font-weight: 600;">
                                    <i class='bx bx-save'></i> Save Changes
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- End Profile Tab -->

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="assessor-container">
                <div style="background: white; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 0.5rem 1.5rem var(--shadow-color);">
                    <h2 style="font-size: 2.4rem; margin-bottom: 2rem; color: var(--main-color);">
                        <i class='bx bx-cog'></i> Settings
                    </h2>

                    <div style="display: grid; gap: 2.5rem;">
                        <!-- Dark Mode Setting -->
                        <div style="padding: 2rem; background: #f3f4f6; border-radius: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Dark Mode</h3>
                                    <p style="font-size: 1.3rem; color: #6b7280;">Toggle dark mode theme</p>
                                </div>
                                <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                    <input type="checkbox" id="settingsDarkMode" onchange="toggleDarkMode()" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Notifications Setting -->
                        <div style="padding: 2rem; background: #f3f4f6; border-radius: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Notifications</h3>
                                    <p style="font-size: 1.3rem; color: #6b7280;">Receive notifications for new submissions</p>
                                </div>
                                <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                    <input type="checkbox" id="settingsNotifications" checked style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--main-color); transition: .4s; border-radius: 34px;"></span>
                                </label>
                            </div>
                        </div>

                        <!-- About Section -->
                        <div style="padding: 2rem; background: linear-gradient(135deg, rgba(117, 78, 249, 0.1), rgba(157, 123, 234, 0.1)); border-radius: 1rem; border: 2px solid var(--main-color);">
                            <h3 style="font-size: 1.8rem; margin-bottom: 1rem; color: var(--main-color);">
                                <i class='bx bx-info-circle'></i> About CodeSmart
                            </h3>
                            <p style="font-size: 1.4rem; margin-bottom: 0.5rem;">Version: 2.4.0</p>
                            <p style="font-size: 1.4rem; margin-bottom: 0.5rem;">LMS Management System for Assessors</p>
                            <p style="font-size: 1.4rem; color: #6b7280;">© 2025 CodeSmart. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Settings Tab -->

    </main>

    <!-- Add/Edit Assignment Modal -->
    <div class="grading-modal" id="assignmentFormModal">
        <div class="grading-modal-content">
            <h2 id="assignmentFormTitle">Tambah Tugas Baru</h2>
            <form id="assignmentForm">
                <div class="form-group">
                    <label>Kelas</label>
                    <select id="assignmentClassId" required style="width: 100%; padding: 1.2rem; font-size: 1.4rem; border: 2px solid #e0e0e0; border-radius: 0.8rem; font-family: 'Poppins', sans-serif;">
                        <!-- Will be populated -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Judul Tugas</label>
                    <input type="text" id="assignmentTitle" required placeholder="Contoh: Latihan Variabel JavaScript">
                </div>
                <div class="form-group">
                    <label>Deskripsi</label>
                    <textarea id="assignmentDescription" required placeholder="Jelaskan detail tugas..."></textarea>
                </div>
                <div class="form-group">
                    <label>Deadline</label>
                    <input type="date" id="assignmentDueDate" required>
                </div>
                <div class="form-group">
                    <label>Nilai Maksimal</label>
                    <input type="number" id="assignmentMaxScore" required value="100" min="0" max="100">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                        <input type="checkbox" id="assignmentFileRequired" checked>
                        <span>Upload file diperlukan</span>
                    </label>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">
                        <i class='bx bx-save'></i> Simpan
                    </button>
                    <button type="button" class="btn-cancel" onclick="closeAssignmentFormModal()">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Grading Modal -->
    <div class="grading-modal" id="gradingModal">
        <div class="grading-modal-content">
            <h2>Nilai Tugas Siswa</h2>

            <div style="background: #f9f9f9; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                <h3 style="font-size: 1.8rem; margin-bottom: 1rem;">Informasi Pengumpulan</h3>
                <p style="margin: 0.5rem 0; font-size: 1.4rem;"><strong>Siswa:</strong> <span id="gradingStudentName"></span></p>
                <p style="margin: 0.5rem 0; font-size: 1.4rem;"><strong>Tugas:</strong> <span id="gradingAssignmentTitle"></span></p>
                <p style="margin: 0.5rem 0; font-size: 1.4rem;"><strong>File:</strong> <span id="gradingFileName"></span></p>
                <p style="margin: 0.5rem 0; font-size: 1.4rem;"><strong>Dikumpulkan:</strong> <span id="gradingSubmittedAt"></span></p>
            </div>

            <form id="gradingForm">
                <div class="form-group">
                    <label>Nilai (0-<span id="gradingMaxScore">100</span>)</label>
                    <input type="number" id="gradingScore" required min="0" max="100" placeholder="Masukkan nilai">
                </div>
                <div class="form-group">
                    <label>Feedback</label>
                    <textarea id="gradingFeedback" placeholder="Berikan feedback untuk siswa..." rows="5"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">
                        <i class='bx bx-check'></i> Simpan Nilai
                    </button>
                    <button type="button" class="btn-cancel" onclick="closeGradingModal()">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../data/database.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/export-import.js"></script>
    <script src="/src/js/pwa.js"></script>

    <script>
        // Check authentication
        const currentUser = authService.getCurrentUser();

        if (!currentUser || currentUser.role !== 'assessor') {
            alert('Akses ditolak! Halaman ini hanya untuk Assessor.');
            window.location.href = '/index.html';
            throw new Error('Unauthorized access'); // Stop script execution
        }

        let currentModuleId = 1; // Default to fundamental
        let currentSubmissionId = null;
        let editingAssignmentId = null;

        // Logout function
        function logout() {
            if (confirm('Yakin ingin logout?')) {
                authService.logout();
            }
        }

        // Load modules
        function loadModules() {
            const moduleSelector = document.getElementById('moduleSelector');
            moduleSelector.innerHTML = Database.modules.map(module => {
                const enrolledCount = Database.enrollments.filter(e => e.moduleId === module.id).length;
                const assignmentsCount = module.classes.reduce((total, cls) =>
                    total + Database.getAssignmentsByClassId(cls.id).length, 0);

                return `
                    <div class="module-card ${module.level} ${module.id === currentModuleId ? 'active' : ''}"
                         onclick="selectModule(${module.id})">
                        <span class="module-level">${module.level.toUpperCase()}</span>
                        <h3>${module.name}</h3>
                        <div class="stats-row">
                            <span><i class='bx bx-book'></i> ${module.classes.length} Kelas</span>
                            <span><i class='bx bx-task'></i> ${assignmentsCount} Tugas</span>
                            <span><i class='bx bx-group'></i> ${enrolledCount} Siswa</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select module
        function selectModule(moduleId) {
            currentModuleId = moduleId;
            loadModules();
            loadCurrentView();
            updateCounts();
        }

        // Switch tab
        function switchTab(view) {
            // Update tabs
            document.querySelectorAll('.manage-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.manage-tab[data-view="${view}"]`).classList.add('active');

            // Update views
            document.querySelectorAll('.manage-view').forEach(v => v.style.display = 'none');
            document.getElementById(view + 'View').style.display = 'block';

            // Load data
            loadCurrentView();
        }

        // Update counts
        function updateCounts() {
            const module = Database.modules.find(m => m.id === currentModuleId);
            const assignments = module.classes.flatMap(cls => Database.getAssignmentsByClassId(cls.id));
            const pendingSubmissions = assignments.flatMap(a => Database.getSubmissionsByAssignmentId(a.id))
                .filter(s => s.score === null);
            const enrolledStudents = Database.enrollments.filter(e => e.moduleId === currentModuleId);
            const pendingPromotions = Database.getPendingPromotions(currentUser.id);

            document.getElementById('classesCount').textContent = `${module.classes.length} kelas`;
            document.getElementById('assignmentsCount').textContent = `${assignments.length} tugas`;
            document.getElementById('submissionsCount').textContent = `${pendingSubmissions.length} pending`;
            document.getElementById('studentsCount').textContent = `${enrolledStudents.length} siswa`;
            document.getElementById('promotionsCount').textContent = `${pendingPromotions.length} pending`;
        }

        // Load current view
        function loadCurrentView() {
            const activeTab = document.querySelector('.manage-tab.active');
            const view = activeTab.dataset.view;

            switch(view) {
                case 'classes':
                    loadClasses();
                    break;
                case 'assignments':
                    loadAssignments();
                    break;
                case 'submissions':
                    loadSubmissions();
                    break;
                case 'students':
                    loadStudentFilters();
                    break;
                case 'promotions':
                    loadPromotions();
                    break;
                case 'reports':
                    loadReportFilters();
                    break;
                case 'export':
                    loadExportStats();
                    break;
            }
        }

        // Load export stats
        function loadExportStats() {
            document.getElementById('exportStatAssignments').textContent = Database.assignments.length;
            document.getElementById('exportStatSubmissions').textContent = Database.submissions.length;
            document.getElementById('exportStatEnrollments').textContent = Database.enrollments.length;
        }

        // Load classes view
        function loadClasses() {
            const module = Database.modules.find(m => m.id === currentModuleId);
            const list = document.getElementById('classesList');

            list.innerHTML = `
                <div style="display: grid; gap: 2rem;">
                    ${module.classes.map((cls, index) => {
                        const assignments = Database.getAssignmentsByClassId(cls.id);
                        return `
                            <div style="border: 2px solid #e0e0e0; border-radius: 1.5rem; padding: 2.5rem; transition: all 0.3s ease;"
                                 onmouseover="this.style.borderColor='var(--main-color)'"
                                 onmouseout="this.style.borderColor='#e0e0e0'">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: inline-block; background: var(--main-color); color: white; padding: 0.5rem 1.2rem; border-radius: 2rem; font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem;">
                                            Kelas ${index + 1}
                                        </div>
                                        <h3 style="font-size: 2.2rem; margin-bottom: 0.8rem;">${cls.title}</h3>
                                        <p style="font-size: 1.4rem; color: #666; line-height: 1.6;">${cls.description}</p>
                                        <div style="margin-top: 1.5rem; display: flex; gap: 2rem; font-size: 1.3rem; color: #666;">
                                            <span><i class='bx bx-task'></i> ${assignments.length} Tugas</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Load assignments view
        function loadAssignments() {
            const module = Database.modules.find(m => m.id === currentModuleId);
            const allAssignments = module.classes.flatMap(cls =>
                Database.getAssignmentsByClassId(cls.id).map(a => ({...a, className: cls.title}))
            );

            const list = document.getElementById('assignmentsList');

            if (allAssignments.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: #999;">
                        <i class='bx bx-task-x' style="font-size: 6rem;"></i>
                        <p style="margin-top: 1.5rem; font-size: 1.6rem;">Belum ada tugas. Klik "Tambah Tugas Baru" untuk membuat tugas.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = `
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th>Kelas</th>
                            <th>Judul Tugas</th>
                            <th>Deadline</th>
                            <th>Nilai Maks</th>
                            <th>Pengumpulan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allAssignments.map(assignment => {
                            const submissions = Database.getSubmissionsByAssignmentId(assignment.id);
                            const gradedCount = submissions.filter(s => s.score !== null).length;
                            return `
                                <tr>
                                    <td>${assignment.className}</td>
                                    <td><strong>${assignment.title}</strong><br>
                                        <small style="color: #666;">${assignment.description}</small>
                                    </td>
                                    <td>${new Date(assignment.dueDate).toLocaleDateString('id-ID')}</td>
                                    <td style="text-align: center;">${assignment.maxScore}</td>
                                    <td>${submissions.length} (${gradedCount} dinilai)</td>
                                    <td>
                                        <button class="grade-btn" onclick="editAssignment(${assignment.id})" style="margin-right: 0.5rem;">
                                            <i class='bx bx-edit'></i> Edit
                                        </button>
                                        <button class="grade-btn" onclick="deleteAssignment(${assignment.id})" style="background: #ef4444;">
                                            <i class='bx bx-trash'></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Load submissions view
        function loadSubmissions() {
            const module = Database.modules.find(m => m.id === currentModuleId);
            const allAssignments = module.classes.flatMap(cls => Database.getAssignmentsByClassId(cls.id));
            let allSubmissions = allAssignments.flatMap(a => {
                const subs = Database.getSubmissionsByAssignmentId(a.id);
                return subs.map(s => ({
                    ...s,
                    assignmentTitle: a.title,
                    assignmentMaxScore: a.maxScore,
                    studentName: Database.findUserById(s.userId)?.name || 'Unknown'
                }));
            });

            // Apply filters
            const filterAssignment = document.getElementById('filterAssignment').value;
            const filterStatus = document.getElementById('filterStatus').value;

            if (filterAssignment) {
                allSubmissions = allSubmissions.filter(s => s.assignmentId == filterAssignment);
            }

            if (filterStatus === 'pending') {
                allSubmissions = allSubmissions.filter(s => s.score === null);
            } else if (filterStatus === 'graded') {
                allSubmissions = allSubmissions.filter(s => s.score !== null);
            }

            // Populate filter dropdown
            const filterAssignmentSelect = document.getElementById('filterAssignment');
            const currentValue = filterAssignmentSelect.value;
            filterAssignmentSelect.innerHTML = '<option value="">Semua Tugas</option>' +
                allAssignments.map(a => `<option value="${a.id}" ${a.id == currentValue ? 'selected' : ''}>${a.title}</option>`).join('');

            const list = document.getElementById('submissionsList');

            if (allSubmissions.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: #999;">
                        <i class='bx bx-file-blank' style="font-size: 6rem;"></i>
                        <p style="margin-top: 1.5rem; font-size: 1.6rem;">Belum ada pengumpulan tugas yang sesuai filter</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = `
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th>Siswa</th>
                            <th>Tugas</th>
                            <th>File</th>
                            <th>Dikumpulkan</th>
                            <th>Nilai</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allSubmissions.map(submission => {
                            const isGraded = submission.score !== null;
                            return `
                                <tr>
                                    <td><strong>${submission.studentName}</strong></td>
                                    <td>${submission.assignmentTitle}</td>
                                    <td>
                                        <a href="#" class="download-link">
                                            <i class='bx bx-download'></i> ${submission.fileName}
                                        </a>
                                    </td>
                                    <td>${new Date(submission.submittedAt).toLocaleDateString('id-ID')}</td>
                                    <td>
                                        ${isGraded ?
                                            `<span class="score-display">${submission.score}/${submission.assignmentMaxScore}</span>` :
                                            '<span style="color: #fbbf24;">Belum Dinilai</span>'
                                        }
                                    </td>
                                    <td>
                                        <button class="grade-btn" onclick="openGrading(${submission.id})">
                                            <i class='bx ${isGraded ? "bx-edit" : "bx-check-circle"}'></i>
                                            ${isGraded ? 'Edit Nilai' : 'Beri Nilai'}
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Load students view
        function loadStudents() {
            const enrollments = Database.enrollments.filter(e => e.moduleId === currentModuleId);
            const list = document.getElementById('studentsList');

            if (enrollments.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: #999;">
                        <i class='bx bx-group' style="font-size: 6rem;"></i>
                        <p style="margin-top: 1.5rem; font-size: 1.6rem;">Belum ada siswa terdaftar di modul ini</p>
                    </div>
                `;
                return;
            }

            const studentsData = enrollments.map(e => {
                const student = Database.findUserById(e.userId);
                const submissions = Database.getSubmissionsByUserId(e.userId);
                const gradedSubmissions = submissions.filter(s => s.score !== null);
                const avgScore = gradedSubmissions.length > 0 ?
                    gradedSubmissions.reduce((sum, s) => sum + s.score, 0) / gradedSubmissions.length : 0;

                return {
                    ...student,
                    progress: e.progress,
                    completedClasses: e.completedClasses.length,
                    totalSubmissions: submissions.length,
                    gradedSubmissions: gradedSubmissions.length,
                    avgScore: avgScore.toFixed(1)
                };
            });

            list.innerHTML = `
                <div class="student-progress-grid">
                    ${studentsData.map(student => {
                        const initials = student.name.split(' ').map(n => n[0]).join('').toUpperCase();
                        return `
                            <div class="student-card">
                                <div class="student-header">
                                    <div class="student-avatar">${initials}</div>
                                    <div>
                                        <div class="student-name">${student.name}</div>
                                        <div class="student-email">${student.email}</div>
                                    </div>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-label">
                                        <span>Progress Kelas</span>
                                        <span><strong>${student.progress}%</strong></span>
                                    </div>
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar-fill" style="width: ${student.progress}%"></div>
                                    </div>
                                </div>
                                <div class="assignments-summary">
                                    <div class="summary-item">
                                        <div class="summary-value">${student.completedClasses}</div>
                                        <div class="summary-label">Kelas Selesai</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value">${student.gradedSubmissions}/${student.totalSubmissions}</div>
                                        <div class="summary-label">Tugas Dinilai</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value">${student.avgScore}</div>
                                        <div class="summary-label">Rata-rata Nilai</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Open add assignment modal
        function openAddAssignmentModal() {
            editingAssignmentId = null;
            document.getElementById('assignmentFormTitle').textContent = 'Tambah Tugas Baru';
            document.getElementById('assignmentForm').reset();

            const module = Database.modules.find(m => m.id === currentModuleId);
            const classSelect = document.getElementById('assignmentClassId');
            classSelect.innerHTML = module.classes.map(cls =>
                `<option value="${cls.id}">${cls.title}</option>`
            ).join('');

            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 7);
            document.getElementById('assignmentDueDate').value = dueDate.toISOString().split('T')[0];

            document.getElementById('assignmentFormModal').classList.add('active');
        }

        function closeAssignmentFormModal() {
            document.getElementById('assignmentFormModal').classList.remove('active');
        }

        function editAssignment(assignmentId) {
            editingAssignmentId = assignmentId;
            const assignment = Database.assignments.find(a => a.id === assignmentId);

            document.getElementById('assignmentFormTitle').textContent = 'Edit Tugas';

            const module = Database.modules.find(m => m.id === currentModuleId);
            const classSelect = document.getElementById('assignmentClassId');
            classSelect.innerHTML = module.classes.map(cls =>
                `<option value="${cls.id}" ${cls.id === assignment.classId ? 'selected' : ''}>${cls.title}</option>`
            ).join('');

            document.getElementById('assignmentTitle').value = assignment.title;
            document.getElementById('assignmentDescription').value = assignment.description;
            document.getElementById('assignmentDueDate').value = assignment.dueDate;
            document.getElementById('assignmentMaxScore').value = assignment.maxScore;
            document.getElementById('assignmentFileRequired').checked = assignment.fileRequired;

            document.getElementById('assignmentFormModal').classList.add('active');
        }

        function deleteAssignment(assignmentId) {
            if (!confirm('Hapus tugas ini? Semua pengumpulan juga akan dihapus.')) return;

            Database.deleteAssignment(assignmentId);
            saveToLocalStorage();
            loadAssignments();
            updateCounts();
        }

        document.getElementById('assignmentForm').onsubmit = function(e) {
            e.preventDefault();

            const data = {
                classId: parseInt(document.getElementById('assignmentClassId').value),
                title: document.getElementById('assignmentTitle').value,
                description: document.getElementById('assignmentDescription').value,
                dueDate: document.getElementById('assignmentDueDate').value,
                maxScore: parseInt(document.getElementById('assignmentMaxScore').value),
                fileRequired: document.getElementById('assignmentFileRequired').checked,
                createdBy: currentUser.id
            };

            if (editingAssignmentId) {
                Database.updateAssignment(editingAssignmentId, data);
            } else {
                Database.addAssignment(data);
            }

            saveToLocalStorage();
            closeAssignmentFormModal();
            loadAssignments();
            updateCounts();
        };

        function openGrading(submissionId) {
            // Redirect to enhanced grading interface
            window.location.href = `grading-enhanced.html?id=${submissionId}`;
        }

        function closeGradingModal() {
            document.getElementById('gradingModal').classList.remove('active');
        }

        document.getElementById('gradingForm').onsubmit = function(e) {
            e.preventDefault();

            const score = parseInt(document.getElementById('gradingScore').value);
            const feedback = document.getElementById('gradingFeedback').value;

            Database.gradeSubmission(currentSubmissionId, score, feedback, currentUser.id);
            saveToLocalStorage();

            alert('Nilai berhasil disimpan!');
            closeGradingModal();
            loadSubmissions();
            updateCounts();
        };

        document.querySelectorAll('.grading-modal').forEach(modal => {
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            };
        });

        // ==================== PROMOTIONS MANAGEMENT ====================

        function loadPromotions() {
            loadFromLocalStorage();
            const promotions = Database.getPendingPromotions(currentUser.id);
            const list = document.getElementById('promotionsList');

            if (promotions.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: #9ca3af;">
                        <i class='bx bx-trophy' style="font-size: 6rem; opacity: 0.3;"></i>
                        <p style="font-size: 1.6rem; margin-top: 1rem;">Tidak ada permintaan naik tingkat saat ini</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = `
                <div style="display: grid; gap: 2rem;">
                    ${promotions.map(promo => {
                        const module = Database.modules.find(m => m.id === promo.moduleId);
                        const requestDate = new Date(promo.requestedAt).toLocaleDateString('id-ID');

                        return `
                            <div style="border: 2px solid #fbbf24; border-radius: 1.5rem; padding: 2.5rem; background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(245, 158, 11, 0.05));">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                                    <div>
                                        <h3 style="font-size: 2rem; margin-bottom: 0.5rem;">
                                            <i class='bx bx-user-circle'></i> ${promo.userName}
                                        </h3>
                                        <p style="font-size: 1.4rem; color: #6b7280;">${promo.userEmail}</p>
                                    </div>
                                    <span style="padding: 0.8rem 1.5rem; background: #fbbf24; color: white; border-radius: 2rem; font-size: 1.2rem; font-weight: 600;">
                                        MENUNGGU
                                    </span>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                                    <div>
                                        <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.3rem;">Modul Tujuan</p>
                                        <p style="font-size: 1.5rem; font-weight: 600;">${module ? module.name : 'Unknown'}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.3rem;">Modul Saat Ini</p>
                                        <p style="font-size: 1.5rem; font-weight: 600;">${promo.currentModule ? promo.currentModule.toUpperCase() : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.3rem;">Skor Pretest</p>
                                        <p style="font-size: 1.5rem; font-weight: 600;">${promo.pretestScore || 0}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.3rem;">Tanggal Ajuan</p>
                                        <p style="font-size: 1.5rem; font-weight: 600;">${requestDate}</p>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button onclick="reviewPromotion(${promo.userId}, ${promo.id}, 'rejected')"
                                            class="btn-lms"
                                            style="background: #ef4444; padding: 1rem 2rem;">
                                        <i class='bx bx-x'></i> Tolak
                                    </button>
                                    <button onclick="reviewPromotion(${promo.userId}, ${promo.id}, 'approved')"
                                            class="btn-lms btn-primary"
                                            style="padding: 1rem 2rem;">
                                        <i class='bx bx-check'></i> Setujui
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function reviewPromotion(userId, requestId, status) {
            const action = status === 'approved' ? 'menyetujui' : 'menolak';
            if (!confirm(`Yakin ingin ${action} permintaan naik tingkat ini?`)) return;

            loadFromLocalStorage();
            const result = Database.reviewPromotion(userId, requestId, status, currentUser.id);

            if (result) {
                saveToLocalStorage();
                alert(`Permintaan naik tingkat telah ${status === 'approved' ? 'disetujui' : 'ditolak'}!`);
                loadPromotions();
                updateCounts();
            } else {
                alert('Terjadi kesalahan. Silakan coba lagi.');
            }
        }

        // ==================== STUDENTS BY CLASS ====================

        function loadStudentFilters() {
            loadFromLocalStorage();
            const module = Database.modules.find(m => m.id === currentModuleId);
            const filterClass = document.getElementById('filterClass');

            // Populate class filter
            filterClass.innerHTML = '<option value="">Pilih Kelas</option>' +
                module.classes.map(cls => `<option value="${cls.id}">${cls.title}</option>`).join('');

            document.getElementById('studentsList').innerHTML = `
                <div style="text-align: center; padding: 4rem; color: #9ca3af;">
                    <i class='bx bx-group' style="font-size: 6rem; opacity: 0.3;"></i>
                    <p style="font-size: 1.6rem; margin-top: 1rem;">Pilih kelas untuk melihat daftar siswa</p>
                </div>
            `;
        }

        function loadStudentsByClass() {
            const classId = parseInt(document.getElementById('filterClass').value);
            if (!classId) {
                loadStudentFilters();
                return;
            }

            loadFromLocalStorage();
            const students = Database.getStudentsByClass(classId);
            const list = document.getElementById('studentsList');

            if (students.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: #9ca3af;">
                        <i class='bx bx-group' style="font-size: 6rem; opacity: 0.3;"></i>
                        <p style="font-size: 1.6rem; margin-top: 1rem;">Belum ada siswa di kelas ini</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 1.5rem; text-align: left; font-size: 1.4rem;">Nama</th>
                                <th style="padding: 1.5rem; text-align: left; font-size: 1.4rem;">Email</th>
                                <th style="padding: 1.5rem; text-align: center; font-size: 1.4rem;">Progress</th>
                                <th style="padding: 1.5rem; text-align: center; font-size: 1.4rem;">Tugas</th>
                                <th style="padding: 1.5rem; text-align: center; font-size: 1.4rem;">Rata-rata</th>
                                <th style="padding: 1.5rem; text-align: center; font-size: 1.4rem;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(student => `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 1.5rem; font-size: 1.4rem; font-weight: 600;">${student.name}</td>
                                    <td style="padding: 1.5rem; font-size: 1.4rem; color: #6b7280;">${student.email}</td>
                                    <td style="padding: 1.5rem; text-align: center;">
                                        <div style="display: inline-block; padding: 0.5rem 1rem; background: ${student.progress >= 80 ? '#10b981' : student.progress >= 50 ? '#f59e0b' : '#ef4444'}; color: white; border-radius: 2rem; font-size: 1.3rem; font-weight: 600;">
                                            ${student.progress}%
                                        </div>
                                    </td>
                                    <td style="padding: 1.5rem; text-align: center; font-size: 1.4rem;">
                                        ${student.submittedAssignments}/${student.totalAssignments}
                                    </td>
                                    <td style="padding: 1.5rem; text-align: center; font-size: 1.4rem; font-weight: 600;">
                                        ${student.avgScore}
                                    </td>
                                    <td style="padding: 1.5rem; text-align: center;">
                                        <button onclick="viewStudentReportDirect(${student.id})" class="btn-lms" style="padding: 0.8rem 1.5rem; font-size: 1.3rem;">
                                            <i class='bx bx-bar-chart-alt-2'></i> Lihat Laporan
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ==================== LEARNING REPORTS ====================

        function loadReportFilters() {
            loadFromLocalStorage();
            const selectStudent = document.getElementById('selectStudent');

            // Get all students from all modules
            const allStudents = Database.users.filter(u => u.role === 'user');

            selectStudent.innerHTML = '<option value="">Pilih Siswa</option>' +
                allStudents.map(student => `<option value="${student.id}">${student.name} - ${student.email}</option>`).join('');

            document.getElementById('reportContent').innerHTML = `
                <div style="text-align: center; padding: 4rem; color: #9ca3af;">
                    <i class='bx bx-bar-chart-alt-2' style="font-size: 6rem; opacity: 0.3;"></i>
                    <p style="font-size: 1.6rem; margin-top: 1rem;">Pilih siswa untuk melihat laporan belajar</p>
                </div>
            `;
        }

        function loadStudentReport() {
            const userId = parseInt(document.getElementById('selectStudent').value);
            if (!userId) {
                loadReportFilters();
                return;
            }

            viewStudentReportDirect(userId);
        }

        function viewStudentReportDirect(userId) {
            loadFromLocalStorage();
            const report = Database.getLearningReport(userId);

            if (!report) {
                alert('Laporan tidak ditemukan');
                return;
            }

            const reportContent = document.getElementById('reportContent');

            // Calculate totals
            const totalProgress = report.modules.length > 0
                ? Math.round(report.modules.reduce((sum, m) => sum + m.progress, 0) / report.modules.length)
                : 0;
            const totalAssignments = report.modules.reduce((sum, m) => sum + m.totalAssignments, 0);
            const totalSubmitted = report.modules.reduce((sum, m) => sum + m.submittedAssignments, 0);
            const totalGraded = report.modules.reduce((sum, m) => sum + m.gradedAssignments, 0);
            const avgScore = report.modules.length > 0 && report.modules.some(m => m.avgScore > 0)
                ? Math.round(report.modules.reduce((sum, m) => sum + m.avgScore, 0) / report.modules.filter(m => m.avgScore > 0).length)
                : 0;

            reportContent.innerHTML = `
                <div style="background: white; border-radius: 1.5rem; overflow: hidden;">
                    <!-- Student Info Header -->
                    <div style="background: linear-gradient(135deg, var(--main-color), #9d7bea); color: white; padding: 3rem;">
                        <h2 style="font-size: 2.4rem; margin-bottom: 1rem;">${report.userName}</h2>
                        <p style="font-size: 1.5rem; opacity: 0.9;">${report.userEmail}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; margin-top: 2rem;">
                            <div>
                                <p style="font-size: 1.2rem; opacity: 0.8;">Skor Pretest</p>
                                <p style="font-size: 2.4rem; font-weight: 700;">${report.pretestScore || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="font-size: 1.2rem; opacity: 0.8;">Progress Rata-rata</p>
                                <p style="font-size: 2.4rem; font-weight: 700;">${totalProgress}%</p>
                            </div>
                            <div>
                                <p style="font-size: 1.2rem; opacity: 0.8;">Tugas Dinilai</p>
                                <p style="font-size: 2.4rem; font-weight: 700;">${totalGraded}/${totalAssignments}</p>
                            </div>
                            <div>
                                <p style="font-size: 1.2rem; opacity: 0.8;">Rata-rata Nilai</p>
                                <p style="font-size: 2.4rem; font-weight: 700;">${avgScore}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Module Reports -->
                    <div style="padding: 3rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3 style="font-size: 2rem;">Detail per Modul</h3>
                            <button onclick="exportStudentReport(${userId})" class="btn-lms btn-primary">
                                <i class='bx bx-download'></i> Export Laporan (JSON)
                            </button>
                        </div>

                        <div style="display: grid; gap: 2rem;">
                            ${report.modules.map(module => `
                                <div style="border: 2px solid #e5e7eb; border-radius: 1.2rem; padding: 2rem;">
                                    <h4 style="font-size: 1.8rem; margin-bottom: 1.5rem; color: var(--main-color);">
                                        <i class='bx bx-book'></i> ${module.moduleName}
                                    </h4>

                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem;">
                                        <div style="text-align: center; padding: 1.5rem; background: #f3f4f6; border-radius: 0.8rem;">
                                            <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.5rem;">Progress</p>
                                            <p style="font-size: 2rem; font-weight: 700; color: ${module.progress >= 80 ? '#10b981' : module.progress >= 50 ? '#f59e0b' : '#ef4444'};">${module.progress}%</p>
                                        </div>
                                        <div style="text-align: center; padding: 1.5rem; background: #f3f4f6; border-radius: 0.8rem;">
                                            <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.5rem;">Kelas Selesai</p>
                                            <p style="font-size: 2rem; font-weight: 700;">${module.completedClasses}/${module.totalClasses}</p>
                                        </div>
                                        <div style="text-align: center; padding: 1.5rem; background: #f3f4f6; border-radius: 0.8rem;">
                                            <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.5rem;">Tugas Dikumpulkan</p>
                                            <p style="font-size: 2rem; font-weight: 700;">${module.submittedAssignments}/${module.totalAssignments}</p>
                                        </div>
                                        <div style="text-align: center; padding: 1.5rem; background: #f3f4f6; border-radius: 0.8rem;">
                                            <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.5rem;">Tugas Dinilai</p>
                                            <p style="font-size: 2rem; font-weight: 700;">${module.gradedAssignments}/${module.submittedAssignments}</p>
                                        </div>
                                        <div style="text-align: center; padding: 1.5rem; background: #f3f4f6; border-radius: 0.8rem;">
                                            <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.5rem;">Rata-rata Nilai</p>
                                            <p style="font-size: 2rem; font-weight: 700; color: ${module.avgScore >= 75 ? '#10b981' : module.avgScore >= 60 ? '#f59e0b' : '#ef4444'};">${module.avgScore}</p>
                                        </div>
                                        <div style="text-align: center; padding: 1.5rem; background: #f3f4f6; border-radius: 0.8rem;">
                                            <p style="font-size: 1.2rem; color: #6b7280; margin-bottom: 0.5rem;">Tanggal Daftar</p>
                                            <p style="font-size: 1.4rem; font-weight: 600;">${new Date(module.enrolledAt).toLocaleDateString('id-ID')}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function exportStudentReport(userId) {
            loadFromLocalStorage();
            const report = Database.getLearningReport(userId);

            if (!report) {
                alert('Laporan tidak ditemukan');
                return;
            }

            ExportImport.exportToJSON(report, `codesmart-report-${report.userName.toLowerCase().replace(/\s/g, '-')}`);
        }

        // ==================== SIDEBAR & NAVIGATION ====================

        // Setup sidebar navigation
        function setupSidebarNavigation() {
            const menuLinks = document.querySelectorAll('.menu-link');

            menuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (link.getAttribute('onclick')) return; // Skip logout link

                    e.preventDefault();
                    const tabName = link.dataset.tab;
                    if (tabName) {
                        switchMainTab(tabName);
                        // Update active state
                        menuLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    }
                });
            });

            // Menu toggle for mobile
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
        }

        // Switch main tabs
        function switchMainTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Update page title
            const titles = {
                lms: 'LMS Management',
                profile: 'Profile Settings',
                settings: 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || tabName;
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeToggle = document.getElementById('darkModeToggle');

            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                darkModeToggle.classList.replace('bx-moon', 'bx-sun');
            } else {
                localStorage.setItem('darkMode', 'disabled');
                darkModeToggle.classList.replace('bx-sun', 'bx-moon');
            }
        }

        // Load user profile data
        function loadUserProfile() {
            const user = authService.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                document.getElementById('profileName').value = user.name || '';
                document.getElementById('profileEmail').value = user.email || '';
                document.getElementById('profilePhone').value = user.phone || '';
                document.getElementById('profileUsername').value = user.username || '';
                document.getElementById('profileRole').value = user.role || '';

                // Load profile photo
                const photoPreview = document.getElementById('profilePhotoPreview');
                if (user.photoUrl) {
                    photoPreview.src = user.photoUrl;
                } else {
                    photoPreview.src = generateAvatarUrl(user.name);
                }

                // Check profile completion
                initProfileCompletionIndicator(user);
            }
        }

        // Update profile
        function updateProfile(event) {
            event.preventDefault();

            const name = document.getElementById('profileName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();

            // Validate name
            const nameValidation = validateName(name);
            if (!nameValidation.valid) {
                alert(nameValidation.message);
                return;
            }

            // Validate email
            const emailValidation = validateEmail(email);
            if (!emailValidation.valid) {
                alert(emailValidation.message);
                return;
            }

            // Validate phone if provided
            if (phone) {
                const phoneValidation = validatePhoneNumber(phone);
                if (!phoneValidation.valid) {
                    const phoneError = document.getElementById('phoneError');
                    phoneError.textContent = phoneValidation.message;
                    phoneError.style.display = 'block';
                    return;
                } else {
                    document.getElementById('phoneError').style.display = 'none';
                }
            }

            const updates = {
                name: name,
                email: email,
                phone: phone,
                photoUrl: currentUser.photoUrl || ''
            };

            const result = authService.updateCurrentUser(updates);
            if (result.success) {
                alert('Profile updated successfully!');
                document.getElementById('userName').textContent = updates.name;

                // Update avatar in header
                const headerAvatar = document.getElementById('userAvatar');
                if (updates.photoUrl) {
                    headerAvatar.innerHTML = `<img src="${updates.photoUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    headerAvatar.textContent = updates.name.charAt(0).toUpperCase();
                }

                // Refresh profile completion indicator
                currentUser = result.user;
                initProfileCompletionIndicator(currentUser);
            } else {
                alert('Failed to update profile: ' + result.message);
            }
        }

        // Handle Profile Photo Upload
        async function handleProfilePhotoUpload(input) {
            const preview = document.getElementById('profilePhotoPreview');

            try {
                const photoUrl = await handlePhotoUpload(input, preview);

                if (photoUrl) {
                    // Store in current user object temporarily
                    currentUser.photoUrl = photoUrl;

                    // Auto-save to database
                    const result = authService.updateCurrentUser({ photoUrl: photoUrl });
                    if (result.success) {
                        // Update header avatar
                        const headerAvatar = document.getElementById('userAvatar');
                        headerAvatar.innerHTML = `<img src="${photoUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;

                        alert('Profile photo uploaded successfully!');

                        // Refresh profile completion indicator
                        currentUser = result.user;
                        initProfileCompletionIndicator(currentUser);
                    } else {
                        alert('Failed to save photo. Please try again.');
                        preview.src = currentUser.photoUrl || generateAvatarUrl(currentUser.name);
                    }
                }
            } catch (error) {
                console.error('Photo upload error:', error);
                alert('Failed to upload photo. Please try again.');
            }
        }

        // Initialize on load
        window.onload = () => {
            // Setup sidebar navigation
            setupSidebarNavigation();

            // Load user profile
            loadUserProfile();

            // Check dark mode preference
            const savedMode = localStorage.getItem('darkMode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (savedMode === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.classList.replace('bx-moon', 'bx-sun');
            }

            // Dark mode toggle event
            darkModeToggle.addEventListener('click', toggleDarkMode);

            // Load LMS data
            loadModules();
            loadCurrentView();
            updateCounts();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('pwaLoading').style.display = 'none';
            }, 500);
        };
    </script>
</body>
</html>
