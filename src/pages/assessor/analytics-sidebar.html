<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - CodeSmart Assessor</title>
    <link rel="icon" type="image/svg+xml" href="/src/favicon.svg">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="../../css/admin-sidebar.css">
                <link rel="stylesheet" href="../../css/notification.css">
    <link rel="stylesheet" href="../../css/modal-system.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Container */
        .analytics-container {
            padding: 0;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            margin-bottom: 3.5rem;
            min-height: 200px;
        }

        .stats-overview:has(.loading),
        .stats-overview:has(.empty-state) {
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 24px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        @media (max-width: 1400px) {
            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-overview {
                grid-template-columns: 1fr;
            }
        }

        /* Stat Cards */
        .stat-card {
            background: white;
            padding: 2.5rem 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25);
            transform: translateY(-8px);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:nth-child(1) .stat-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        /* Stat Icon */
        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2rem;
            color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        }

        .stat-icon.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-icon.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .stat-icon.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .stat-icon.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .stat-icon.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, #9775fa 0%, #7048e8 100%);
        }

        /* Stat Info */
        .stat-info {
            flex: 1;
            min-width: 0;
        }

        .stat-info h3 {
            font-size: 3.2rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 0.5rem;
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .stat-info p {
            font-size: 1.4rem;
            font-weight: 500;
            color: #6b7280;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2.5rem;
            margin-bottom: 3.5rem;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Card */
        .chart-card {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .chart-card:hover {
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2);
            transform: translateY(-4px);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .chart-card:hover::before {
            opacity: 1;
        }

        /* Chart Card Header */
        .chart-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding-bottom: 1.8rem;
            border-bottom: 3px solid #f3f4f6;
            position: relative;
        }

        .chart-card h3::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .chart-card h3 i {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 350px;
            padding: 1rem 0;
        }

        .full-width-card {
            grid-column: 1 / -1;
        }

        .at-risk-section {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-top: 1rem;
        }

        .at-risk-section h3 {
            font-size: 2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2.5rem;
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .at-risk-section h3 i {
            color: #ef4444;
            font-size: 2.4rem;
        }

        .risk-table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 12px;
        }

        .risk-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.8rem 2rem;
            text-align: left;
            font-size: 1.35rem;
            font-weight: 700;
            color: white;
            border-bottom: 3px solid rgba(102, 126, 234, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-table td {
            padding: 1.8rem 2rem;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1.45rem;
            color: #4b5563;
        }

        .risk-table tbody tr {
            transition: all 0.2s ease;
        }

        .risk-table tbody tr:hover {
            background: #f9fafb;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .risk-table tbody tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .risk-table {
                display: block;
                overflow-x: auto;
            }
        }

        .risk-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-badge.high {
            background: #fee2e2;
            color: #991b1b;
        }

        .risk-badge.medium {
            background: #fed7aa;
            color: #92400e;
        }

        .risk-badge.low {
            background: #fef3c7;
            color: #854d0e;
        }

        /* Filter Bar Container */
        .filter-bar {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 3.5rem;
            border: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .filter-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Filter Row */
        .filter-row {
            display: flex;
            gap: 3rem;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        /* Filter Sections */
        .filter-section {
            display: flex;
            gap: 1.5rem;
            align-items: flex-end;
        }

        .date-range-section {
            flex: 0 0 auto;
        }

        .quick-range-section {
            flex: 0 0 auto;
            gap: 1rem;
        }

        .actions-section {
            flex: 1;
            justify-content: flex-end;
            min-width: 300px;
        }

        /* Filter Group */
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .filter-row {
                gap: 2rem;
            }

            .actions-section {
                flex: 1 1 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 768px) {
            .filter-bar {
                padding: 2rem;
            }

            .filter-row {
                flex-direction: column;
                gap: 2rem;
            }

            .filter-section {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 1.5rem;
            }

            .date-range-section,
            .quick-range-section,
            .actions-section {
                flex: 1 1 100%;
            }

            .quick-range-section {
                flex-direction: row;
            }
        }

        /* Filter Bar Select */
        .filter-bar select {
            padding: 0 1.5rem;
            padding-right: 4rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: 500;
            background-color: white;
            color: #374151 !important;
            width: 240px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            height: 48px;
            line-height: 48px;
            vertical-align: middle;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.8rem;
            text-indent: 0;
            text-align: left;
        }

        .filter-bar select option {
            padding: 1rem;
            color: #374151;
            background: white;
        }

        @media (max-width: 768px) {
            .filter-bar select {
                width: 100%;
            }
        }

        .filter-bar select:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .filter-bar select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        /* Filter Bar Label */
        .filter-bar label {
            font-size: 1.35rem;
            font-weight: 600;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-bar label i {
            font-size: 1.6rem;
            color: #667eea;
        }

        /* Date Input */
        .date-input {
            padding: 1.1rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: 500;
            background: white;
            color: #374151;
            width: 180px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            height: 48px;
        }

        .date-input:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        /* Quick Range Buttons */
        .btn-quick-range {
            padding: 0 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.35rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            height: 48px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
        }

        .btn-quick-range i {
            font-size: 1.6rem;
        }

        .btn-quick-range::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-quick-range:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-quick-range:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-quick-range:active {
            transform: translateY(0);
        }

        /* Export Button */
        .btn-export {
            padding: 0 2.5rem;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.35rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
            height: 48px;
            white-space: nowrap;
        }

        .btn-export i {
            font-size: 1.6rem;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.4);
        }

        .btn-export:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .btn-export {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 8rem 3rem;
            font-size: 1.6rem;
            font-weight: 500;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            width: 100%;
        }

        .loading i {
            font-size: 5.5rem;
            color: #667eea;
            animation: spin 1.5s linear infinite;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 8rem 3rem;
            color: #9ca3af;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .empty-state i {
            font-size: 7rem;
            color: #d1d5db;
            margin-bottom: 2.5rem;
            display: block;
            opacity: 0.4;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state p {
            font-size: 1.8rem;
            font-weight: 600;
            color: #6b7280;
            margin: 0;
            line-height: 1.6;
        }

        .empty-state p:first-of-type {
            font-size: 2rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <a href="dashboard-sidebar.html" class="sidebar-logo">
                <i class='bx bx-code-alt'></i>
                <span>CodeSmart</span>
            </a>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main</div>
                <a href="dashboard-sidebar.html" class="nav-item">
                    <i class='bx bx-home-alt'></i>
                    <span>Dashboard</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Content Management</div>
                <a href="assignments-sidebar.html" class="nav-item">
                    <i class='bx bx-task'></i>
                    <span>Assignments</span>
                </a>
                <a href="materials-sidebar.html" class="nav-item">
                    <i class='bx bx-folder'></i>
                    <span>Learning Materials</span>
                </a>
                <a href="classes-sidebar.html" class="nav-item">
                    <i class='bx bx-book-open'></i>
                    <span>My Classes</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Grading</div>
                <a href="submissions-sidebar.html" class="nav-item">
                    <i class='bx bx-file'></i>
                    <span>Grade Submissions</span>
                </a>
                <a href="students-sidebar.html" class="nav-item">
                    <i class='bx bx-user-check'></i>
                    <span>Student Progress</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Communication</div>
                <a href="discussions-sidebar.html" class="nav-item">
                    <i class='bx bx-message-square-dots'></i>
                    <span>Discussions</span>
                </a>
                <a href="announcements-sidebar.html" class="nav-item">
                    <i class='bx bx-broadcast'></i>
                    <span>Announcements</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <a href="analytics-sidebar.html" class="nav-item active">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    <span>Analytics</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1 class="page-title-header">Analytics Dashboard
                </h1>
            </div>
            <div class="header-right">
                <div class="notification-bell" id="notificationBellBtn">
                    <i class='bx bx-bell'></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </div>
                <div class="user-menu" id="userMenuToggle">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Assessor</div>
                        <div class="user-role">Assessor</div>
                    </div>

                    <!-- User Dropdown -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-user-name" id="dropdownUserName">Assessor</div>
                            <div class="dropdown-user-email" id="dropdownUserEmail">assessor@codesmart.com</div>
                        </div>
                        <div class="dropdown-menu">
                            <a href="profile.html" class="dropdown-item">
                                <i class='bx bx-user-circle'></i>
                                <span>My Profile</span>
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item danger" onclick="logout(); return false;">
                                <i class='bx bx-log-out'></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Filter Bar (Moved to Top) -->
            <div class="filter-bar" style="margin-bottom: 24px;">
                    <div class="filter-row">
                        <!-- Date Range Section -->
                        <div class="filter-section date-range-section">
                            <div class="filter-group">
                                <label>
                                    <i class='bx bx-calendar'></i>
                                    Start Date
                                </label>
                                <input type="date" id="startDate" class="date-input">
                            </div>
                            <div class="filter-group">
                                <label>
                                    <i class='bx bx-calendar'></i>
                                    End Date
                                </label>
                                <input type="date" id="endDate" class="date-input">
                            </div>
                        </div>

                        <!-- Quick Range Section -->
                        <div class="filter-section quick-range-section">
                            <button class="btn-quick-range" onclick="setQuickRange(7)">
                                <i class='bx bx-time'></i>
                                7 Days
                            </button>
                            <button class="btn-quick-range" onclick="setQuickRange(30)">
                                <i class='bx bx-calendar-check'></i>
                                30 Days
                            </button>
                        </div>

                        <!-- Module & Export Section -->
                        <div class="filter-section actions-section">
                            <div class="filter-group">
                                <label>
                                    <i class='bx bx-book'></i>
                                    Module
                                </label>
                                <select id="filterModule">
                                    <option value="">All Modules</option>
                                </select>
                            </div>
                            <button class="btn-export" onclick="exportAnalytics()">
                                <i class='bx bx-download'></i>
                                Export Report
                            </button>
                        </div>
                    </div>
                </div>

            <!-- Stats Cards -->
            <div class="stats-grid" style="margin-bottom: 24px;">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class='bx bx-group'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalStudentsAnalytics">0</h3>
                        <p>Total Students</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class='bx bx-line-chart'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="avgPerformance">0%</h3>
                        <p>Avg Performance</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class='bx bx-task'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="completionRate">0%</h3>
                        <p>Completion Rate</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class='bx bx-book-open'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeClasses">0</h3>
                        <p>Active Classes</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Container -->
            <div class="analytics-container">
                <!-- Stats Overview -->
                <div class="stats-overview" id="statsOverview">
                    <div class="loading">
                        <i class='bx bx-loader-alt bx-spin'></i> Loading stats...
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Grade Distribution Chart -->
                    <div class="chart-card">
                        <h3>
                            <i class='bx bx-bar-chart'></i>
                            Grade Distribution
                        </h3>
                        <div class="chart-container">
                            <canvas id="gradeChart"></canvas>
                        </div>
                    </div>

                    <!-- Performance Statistics Chart -->
                    <div class="chart-card">
                        <h3>
                            <i class='bx bx-trending-up'></i>
                            Performance Statistics
                        </h3>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- At-Risk Students Section -->
                <div class="at-risk-section">
                    <h3>
                        <i class='bx bx-error'></i>
                        At-Risk Students
                    </h3>
                    <div id="atRiskTableContainer">
                        <div class="loading">
                            <i class='bx bx-loader-alt bx-spin'></i> Loading at-risk students...
                        </div>
                    </div>
                </div>

                <!-- SVM Predictions Analytics Section -->
                <div class="chart-card full-width-card" style="margin-top: 3.5rem;">
                    <h3 style="display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            <i class='bx bx-brain'></i>
                            SVM Predictions Analytics
                        </span>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="loadSVMData()" style="padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                <i class='bx bx-refresh'></i> Refresh
                            </button>
                            <button onclick="runSVMBatchPrediction()" style="padding: 8px 16px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                <i class='bx bx-play-circle'></i> Run Batch
                            </button>
                        </div>
                    </h3>

                    <!-- SVM Stats Grid -->
                    <div id="svmStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin: 24px 0;">
                        <div style="text-align: center; padding: 20px;">
                            <i class='bx bx-loader-alt bx-spin' style="font-size: 32px; color: #667eea;"></i>
                            <p style="margin-top: 12px; color: #6b7280;">Loading SVM data...</p>
                        </div>
                    </div>

                    <!-- SVM Charts -->
                    <div id="svmChartsContainer" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px;">
                            <div>
                                <h4 style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 16px;">Level Distribution</h4>
                                <div style="position: relative; height: 280px;">
                                    <canvas id="svmLevelChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <h4 style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 16px;">Confidence Distribution</h4>
                                <div style="position: relative; height: 280px;">
                                    <canvas id="svmConfidenceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SVM Table -->
                    <div id="svmTableContainer" style="display: none;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #2d3748; margin: 24px 0 16px 0;">Top 10 Recent Predictions</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Student</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Score</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Rule-Based</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">SVM</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Confidence</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Match</th>
                                        <th style="padding: 12px; text-align: left; font-size: 13px;">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="svmPredictionsBody" style="background: white;">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="svmEmptyState" style="display: none; text-align: center; padding: 40px;">
                        <i class='bx bx-brain' style="font-size: 64px; color: #cbd5e0;"></i>
                        <h4 style="color: #4a5568; margin-top: 16px;">No SVM Predictions Yet</h4>
                        <p style="color: #718096; margin: 8px 0 24px 0;">Run batch prediction to generate SVM predictions</p>
                        <button onclick="runSVMBatchPrediction()" style="padding: 12px 24px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            <i class='bx bx-play-circle'></i> Run Batch Prediction
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/src/js/auth.js"></script>
    <script src="/src/js/api-service.js"></script>
    <script src="/src/js/notification-service.js"></script>
    <script src="/src/js/notification-bell.js"></script>
    <script src="/src/js/modal-service.js"></script>
    <script src="/src/js/user-profile-loader.js"></script>
    <script src="/src/js/svm-modal.js"></script>
    <script>
        // Auth check
        if (!authService.requireAuth() || !authService.isAssessor()) {
            window.location.href = '/src/pages/auth/login.html';
        }

        let charts = {};
        let dashboardData = null;
        let modules = [];

        // Load modules
        async function loadModules() {
            try {
                const response = await apiService.getModules();
                if (response.success) {
                    modules = response.data.modules || response.data || [];
                    const filterModule = document.getElementById('filterModule');
                    modules.forEach(module => {
                        const option = document.createElement('option');
                        option.value = module.id;
                        option.textContent = `${module.name} (${module.level.toUpperCase()})`;
                        filterModule.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading modules:', error);
            }
        }

        // Load top stats cards
        async function loadTopStats() {
            try {
                const token = localStorage.getItem('codesmart_token');

                // Load dashboard data for stats
                const dashboardResponse = await fetch('http://localhost:5000/api/v1/analytics/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dashboardData = await dashboardResponse.json();

                // Load grade distribution for avg performance
                const gradeResponse = await fetch('http://localhost:5000/api/v1/analytics/grade-distribution', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const gradeData = await gradeResponse.json();

                // Load assignments to count total
                const assignmentsResponse = await fetch('http://localhost:5000/api/v1/assignments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const assignmentsData = await assignmentsResponse.json();

                if (dashboardData.success && gradeData.success) {
                    const overview = dashboardData.data.overview;
                    const statistics = gradeData.data.statistics;

                    // Update Total Students
                    const totalStudents = overview.total_students || 0;
                    document.getElementById('totalStudentsAnalytics').textContent = totalStudents;

                    // Update Avg Performance (from grade statistics)
                    const avgScore = parseFloat(statistics.average_score) || 0;
                    document.getElementById('avgPerformance').textContent = avgScore.toFixed(1) + '%';

                    // Calculate Completion Rate (graded / total assignments)
                    const totalGraded = parseInt(statistics.total_graded) || 0;
                    const totalAssignments = assignmentsData.success ? (assignmentsData.data.length || 0) : parseInt(overview.total_assignments) || 0;
                    const completionRate = totalAssignments > 0 ? ((totalGraded / totalAssignments) * 100) : 0;
                    document.getElementById('completionRate').textContent = completionRate.toFixed(0) + '%';

                    // Update Active Classes (from modules)
                    const activeClasses = modules.length || 0;
                    document.getElementById('activeClasses').textContent = activeClasses;

                    console.log('‚úÖ Top stats updated:', {
                        totalStudents,
                        avgPerformance: avgScore,
                        completionRate: completionRate.toFixed(0),
                        activeClasses
                    });
                }
            } catch (error) {
                console.error('‚ùå Error loading top stats:', error);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                const token = localStorage.getItem('codesmart_token');
                console.log('üìä Loading dashboard data...');
                console.log('Token available:', !!token);
                console.log('Token value:', token ? token.substring(0, 20) + '...' : 'null');

                const response = await fetch(`http://localhost:5000/api/v1/analytics/dashboard?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response status:', response.status);

                // Handle 401 Unauthorized - Auto-reload after 2 seconds
                if (response.status === 401) {
                    console.error('‚ùå Unauthorized - Token invalid or expired');
                    console.log('üîÑ Auto-reloading page in 2 seconds...');

                    document.getElementById('statsOverview').innerHTML = `
                        <div class="empty-state" style="animation: fadeIn 0.3s ease-in;">
                            <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 2rem;">
                                <i class="bx bx-lock-alt" style="
                                    font-size: 80px;
                                    color: #667eea;
                                    animation: pulse 1.5s ease-in-out infinite;
                                "></i>
                            </div>
                            <p style="font-size: 2rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">
                                Session Expired
                            </p>
                            <p style="font-size: 1.4rem; font-weight: 500; color: #9ca3af; margin-bottom: 2rem;">
                                Refreshing page automatically...
                            </p>
                            <div style="width: 200px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin: 0 auto;">
                                <div style="
                                    width: 0%;
                                    height: 100%;
                                    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                                    animation: progressBar 2s linear forwards;
                                "></div>
                            </div>
                        </div>
                        <style>
                            @keyframes pulse {
                                0%, 100% { transform: scale(1); opacity: 1; }
                                50% { transform: scale(1.1); opacity: 0.8; }
                            }
                            @keyframes progressBar {
                                from { width: 0%; }
                                to { width: 100%; }
                            }
                            @keyframes fadeIn {
                                from { opacity: 0; transform: translateY(20px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                        </style>
                    `;

                    // Auto-reload after 2 seconds
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    return;
                }

                const data = await response.json();
                console.log('Dashboard data:', data);

                if (data.success) {
                    dashboardData = data.data;
                    renderStats();
                    await loadGradeDistribution();
                    await renderPerformanceChart();
                    await loadAtRiskStudents();
                } else {
                    console.error('API returned error:', data.message);
                    // Show empty state if API returns error
                    document.getElementById('statsOverview').innerHTML = `
                        <div class="empty-state">
                            <i class="bx bx-line-chart"></i>
                            <p>No Analytics Data Available</p>
                            <p style="font-size: 1.4rem; font-weight: 500; color: #9ca3af;">${data.message || 'Start collecting data to see insights here'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);
                // Show empty state instead of staying in loading
                document.getElementById('statsOverview').innerHTML = `
                    <div class="empty-state">
                        <i class="bx bx-line-chart"></i>
                        <p>Error Loading Analytics</p>
                        <p style="font-size: 1.4rem; font-weight: 500; color: #9ca3af;">Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        // Render stats
        function renderStats() {
            const container = document.getElementById('statsOverview');
            const overview = dashboardData.overview || dashboardData;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class='bx bx-user'></i>
                    </div>
                    <div class="stat-info">
                        <h3>${overview.total_students || 0}</h3>
                        <p>Total Students</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class='bx bx-check-circle'></i>
                    </div>
                    <div class="stat-info">
                        <h3>${overview.pending_submissions || 0}</h3>
                        <p>Pending Submissions</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class='bx bx-star'></i>
                    </div>
                    <div class="stat-info">
                        <h3>${overview.average_score ? parseFloat(overview.average_score).toFixed(1) : '0'}%</h3>
                        <p>Average Score</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class='bx bx-book-open'></i>
                    </div>
                    <div class="stat-info">
                        <h3>${overview.at_risk_count || 0}</h3>
                        <p>At-Risk Students</p>
                    </div>
                </div>
            `;
        }

        // Load grade distribution
        async function loadGradeDistribution() {
            try {
                const moduleId = document.getElementById('filterModule').value;
                const params = moduleId ? `?module_id=${moduleId}` : '';
                const response = await fetch(`http://localhost:5000/api/v1/analytics/grade-distribution${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('codesmart_token')}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    renderGradeChart(data.data.distribution);
                }
            } catch (error) {
                console.error('Error loading grade distribution:', error);
            }
        }

        // Render grade chart
        function renderGradeChart(distribution) {
            const ctx = document.getElementById('gradeChart');
            if (charts.gradeChart) charts.gradeChart.destroy();

            // Convert array to object if needed
            const gradeMap = {};
            if (Array.isArray(distribution)) {
                distribution.forEach(item => {
                    const grade = item.grade_range;
                    gradeMap[grade] = parseInt(item.count) || 0;
                });
            }

            console.log('Grade distribution:', gradeMap);

            charts.gradeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['A (90-100)', 'B (80-89)', 'C (70-79)', 'D (60-69)', 'F (0-59)'],
                    datasets: [{
                        label: 'Number of Students',
                        data: [
                            gradeMap['A (90-100)'] || 0,
                            gradeMap['B (80-89)'] || 0,
                            gradeMap['C (70-79)'] || 0,
                            gradeMap['D (60-69)'] || 0,
                            gradeMap['F (0-59)'] || 0
                        ],
                        backgroundColor: [
                            'rgba(72, 187, 120, 0.8)',   // A: Success green
                            'rgba(102, 126, 234, 0.8)',  // B: Primary purple
                            'rgba(237, 137, 54, 0.8)',   // C: Warning orange
                            'rgba(255, 107, 107, 0.8)',  // D: Danger red
                            'rgba(156, 163, 175, 0.8)'   // F: Gray
                        ],
                        borderColor: [
                            'rgb(72, 187, 120)',         // A: Success green
                            'rgb(102, 126, 234)',        // B: Primary purple
                            'rgb(237, 137, 54)',         // C: Warning orange
                            'rgb(255, 107, 107)',        // D: Danger red
                            'rgb(156, 163, 175)'         // F: Gray
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Render Performance Statistics Chart
        async function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (charts.performanceChart) charts.performanceChart.destroy();

            try {
                const response = await fetch('http://localhost:5000/api/v1/analytics/grade-distribution', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('codesmart_token')}`
                    }
                });
                const data = await response.json();

                if (data.success && data.data.statistics) {
                    const stats = data.data.statistics;

                    charts.performanceChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Average Score', 'Min Score', 'Max Score', 'Std Deviation'],
                            datasets: [{
                                label: 'Performance Metrics',
                                data: [
                                    parseFloat(stats.average_score) || 0,
                                    stats.min_score || 0,
                                    stats.max_score || 0,
                                    parseFloat(stats.std_deviation) || 0
                                ],
                                backgroundColor: [
                                    'rgba(102, 126, 234, 0.8)',  // Primary purple
                                    'rgba(255, 107, 107, 0.8)',  // Danger red
                                    'rgba(72, 187, 120, 0.8)',   // Success green
                                    'rgba(237, 137, 54, 0.8)'    // Warning orange
                                ],
                                borderColor: [
                                    'rgb(102, 126, 234)',
                                    'rgb(255, 107, 107)',
                                    'rgb(72, 187, 120)',
                                    'rgb(237, 137, 54)'
                                ],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            weight: '600'
                                        },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += context.parsed.toFixed(2);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading performance chart:', error);
            }
        }

        // Load module completion
        async function loadModuleCompletion() {
            try {
                const response = await fetch('http://localhost:5000/api/v1/analytics/module-completion', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('codesmart_token')}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    renderCompletionChart(data.data.modules);
                }
            } catch (error) {
                console.error('Error loading module completion:', error);
            }
        }

        // Render completion chart
        function renderCompletionChart(modulesData) {
            const ctx = document.getElementById('completionChart');
            if (charts.completionChart) charts.completionChart.destroy();

            charts.completionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: modulesData.map(m => m.module_name),
                    datasets: [{
                        label: 'Completion Rate',
                        data: modulesData.map(m => parseFloat(m.completion_rate) || 0),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderColor: [
                            'rgb(102, 126, 234)',
                            'rgb(118, 75, 162)',
                            'rgb(16, 185, 129)',
                            'rgb(59, 130, 246)',
                            'rgb(245, 158, 11)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load engagement metrics
        async function loadEngagementMetrics() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                const response = await fetch(`http://localhost:5000/api/v1/analytics/engagement?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('codesmart_token')}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    renderEngagementChart(data.data.daily_activity);
                }
            } catch (error) {
                console.error('Error loading engagement metrics:', error);
            }
        }

        // Render engagement chart
        function renderEngagementChart(dailyActivity) {
            const ctx = document.getElementById('engagementChart');
            if (charts.engagementChart) charts.engagementChart.destroy();

            const sortedActivity = dailyActivity.sort((a, b) => new Date(a.date) - new Date(b.date));

            charts.engagementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedActivity.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Active Users',
                        data: sortedActivity.map(d => parseInt(d.active_users) || 0),
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Load at-risk students
        async function loadAtRiskStudents() {
            try {
                console.log('üìä Loading at-risk students...');
                const token = localStorage.getItem('codesmart_token');

                const response = await fetch('http://localhost:5000/api/v1/analytics/at-risk-students', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('At-risk students response status:', response.status);

                // Handle 401 Unauthorized
                if (response.status === 401) {
                    console.error('‚ùå Unauthorized - Token invalid');
                    document.getElementById('atRiskTableContainer').innerHTML = '<div class="empty-state"><i class="bx bx-lock-alt"></i><p>Authentication required</p><p style="font-size: 1.4rem;">Please refresh the page</p></div>';
                    return;
                }

                const data = await response.json();
                console.log('At-risk students data:', data);

                if (data.success) {
                    renderAtRiskTable(data.data.at_risk_students);
                } else {
                    document.getElementById('atRiskTableContainer').innerHTML = `<div class="empty-state"><i class="bx bx-error"></i><p>${data.message || 'Error loading at-risk students'}</p></div>`;
                }
            } catch (error) {
                console.error('‚ùå Error loading at-risk students:', error);
                document.getElementById('atRiskTableContainer').innerHTML = '<div class="empty-state"><i class="bx bx-error"></i><p>Error loading at-risk students</p><p style="font-size: 1.4rem;">Please try refreshing</p></div>';
            }
        }

        // Render at-risk table
        function renderAtRiskTable(students) {
            const container = document.getElementById('atRiskTableContainer');

            if (students.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="bx bx-check-circle"></i><p>No at-risk students found</p></div>';
                return;
            }

            container.innerHTML = `
                <table class="risk-table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Email</th>
                            <th>Level</th>
                            <th>Avg Score</th>
                            <th>Total Submissions</th>
                            <th>Last Submission</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.email}</td>
                                <td>${student.current_level || '-'}</td>
                                <td>${student.average_score ? parseFloat(student.average_score).toFixed(1) : '-'}</td>
                                <td>${student.total_submissions || 0}</td>
                                <td>${student.last_submission_date ? formatDate(student.last_submission_date) : 'Never'}</td>
                                <td><span class="risk-badge ${student.risk_level}">${student.risk_level}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return date.toLocaleDateString();
        }

        // Export analytics
        window.exportAnalytics = async function() {
            try {
                const moduleId = document.getElementById('filterModule').value;
                const params = moduleId ? `?module_id=${moduleId}` : '';
                window.location.href = `http://localhost:5000/api/v1/exports/class-summary${params}&token=${localStorage.getItem('codesmart_token')}`;
                if (typeof notificationService !== 'undefined') {
                    notificationService.show('Exporting analytics...', 'info');
                }
            } catch (error) {
                console.error('Error exporting analytics:', error);
                if (typeof notificationService !== 'undefined') {
                    notificationService.show('Error exporting analytics', 'error');
                }
            }
        };

        function logout() {
            modalService.confirm({
                title: '<i class=\'bx bx-log-out\'></i> Confirm Logout',
                message: 'Are you sure you want to logout from CodeSmart?',
                confirmText: 'Yes, Logout',
                cancelText: 'Cancel',
                danger: true,
                onConfirm: function() {
                    authService.logout();
                }
            });
        };

        // Set user info
        const currentUser = authService.getCurrentUser();
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.name || 'Assessor';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'A')[0].toUpperCase();
        }

        // Set quick date range
        window.setQuickRange = function(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];

            loadDashboardData();
        };

        // Initialize default date range (last 30 days)
        function initializeDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        }

        // Event listeners
        document.getElementById('startDate').addEventListener('change', () => {
            loadDashboardData();
        });

        document.getElementById('endDate').addEventListener('change', () => {
            loadDashboardData();
        });

        document.getElementById('filterModule').addEventListener('change', () => {
            loadGradeDistribution();
        });

        // Initialize
        initializeDateRange();

        // Load modules first, then stats (need modules count for active classes)
        loadModules().then(() => {
            loadTopStats();
        });

        loadDashboardData();

        // SVM Analytics Functions
        let svmLevelChart = null;
        let svmConfidenceChart = null;
        let svmPredictionsData = [];

        // Initialize SVM charts
        function initSVMCharts() {
            const levelCtx = document.getElementById('svmLevelChart')?.getContext('2d');
            if (levelCtx && !svmLevelChart) {
                svmLevelChart = new Chart(levelCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Fundamental', 'Intermediate', 'Advance'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#fa709a', '#4facfe', '#43e97b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const confCtx = document.getElementById('svmConfidenceChart')?.getContext('2d');
            if (confCtx && !svmConfidenceChart) {
                svmConfidenceChart = new Chart(confCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%'],
                        datasets: [{
                            label: 'Predictions',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(102, 126, 234, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        }

        // Load SVM data
        async function loadSVMData() {
            try {
                const response = await apiService.fetchWithAuth('/ml/stats');

                if (response.success && response.data.statistics.total_predictions > 0) {
                    const stats = response.data.statistics;
                    const predictions = response.data.predictions || [];

                    // Update stats grid
                    const statsHTML = `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${stats.total_predictions}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Total Predictions</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #fa709a;">${stats.fundamental_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Fundamental</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #4facfe;">${stats.intermediate_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Intermediate</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #43e97b;">${stats.advance_count}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Advance</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #10b981;">${stats.matching_predictions}</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Matching</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 28px; font-weight: 700; color: #667eea;">${(stats.avg_confidence || 0).toFixed(1)}%</div>
                            <div style="font-size: 13px; color: #718096; margin-top: 8px;">Avg Confidence</div>
                        </div>
                    `;
                    document.getElementById('svmStatsGrid').innerHTML = statsHTML;

                    // Initialize and update charts
                    initSVMCharts();
                    updateSVMCharts(predictions);

                    // Render table
                    renderSVMTable(predictions);
                    svmPredictionsData = predictions;

                    // Show charts and table
                    document.getElementById('svmChartsContainer').style.display = 'block';
                    document.getElementById('svmTableContainer').style.display = 'block';
                    document.getElementById('svmEmptyState').style.display = 'none';
                } else {
                    showSVMEmptyState();
                }
            } catch (error) {
                console.error('Error loading SVM data:', error);
                showSVMEmptyState();
            }
        }

        // Update SVM charts
        function updateSVMCharts(predictions) {
            if (!svmLevelChart || !svmConfidenceChart) return;

            const levelCounts = {
                fundamental: predictions.filter(p => p.svm_predicted_level === 'fundamental').length,
                intermediate: predictions.filter(p => p.svm_predicted_level === 'intermediate').length,
                advance: predictions.filter(p => p.svm_predicted_level === 'advance').length
            };

            svmLevelChart.data.datasets[0].data = [levelCounts.fundamental, levelCounts.intermediate, levelCounts.advance];
            svmLevelChart.update();

            const confRanges = [0, 0, 0, 0, 0];
            predictions.forEach(p => {
                const conf = p.svm_confidence || 0;
                if (conf <= 20) confRanges[0]++;
                else if (conf <= 40) confRanges[1]++;
                else if (conf <= 60) confRanges[2]++;
                else if (conf <= 80) confRanges[3]++;
                else confRanges[4]++;
            });

            svmConfidenceChart.data.datasets[0].data = confRanges;
            svmConfidenceChart.update();
        }

        // Render SVM table
        function renderSVMTable(predictions) {
            const tbody = document.getElementById('svmPredictionsBody');
            tbody.innerHTML = '';

            predictions.slice(0, 10).forEach(pred => {
                const match = pred.current_level === pred.svm_predicted_level;
                const matchText = match ? '‚úÖ Match' : '‚ùå Different';
                const matchColor = match ? '#10b981' : '#ef4444';

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e5e7eb';
                row.style.cursor = 'pointer';
                row.style.transition = 'all 0.2s';

                // Add hover effect
                row.addEventListener('mouseenter', function() {
                    this.style.background = '#f8fafc';
                    this.style.transform = 'scale(1.01)';
                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                });

                row.addEventListener('mouseleave', function() {
                    this.style.background = '';
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });

                // Add click handler to show modal
                row.addEventListener('click', function() {
                    svmModal.show(pred);
                });

                row.innerHTML = `
                    <td style="padding: 12px; font-size: 13px;"><strong>${pred.name || 'Unknown'}</strong></td>
                    <td style="padding: 12px; font-size: 13px;">${pred.pretest_score || 0}</td>
                    <td style="padding: 12px; font-size: 13px;"><span style="padding: 4px 8px; border-radius: 6px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; font-size: 11px; font-weight: 600;">${pred.current_level || '-'}</span></td>
                    <td style="padding: 12px; font-size: 13px;"><span style="padding: 4px 8px; border-radius: 6px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; font-size: 11px; font-weight: 600;">${pred.svm_predicted_level || '-'}</span></td>
                    <td style="padding: 12px; font-size: 13px;">
                        <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${pred.svm_confidence || 0}%; height: 100%; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                        </div>
                        <div style="font-size: 11px; color: #718096; margin-top: 4px;">${(pred.svm_confidence || 0).toFixed(1)}%</div>
                    </td>
                    <td style="padding: 12px; font-size: 13px; color: ${matchColor}; font-weight: 600;">${matchText}</td>
                    <td style="padding: 12px; font-size: 13px; color: #6b7280;">${pred.prediction_date ? new Date(pred.prediction_date).toLocaleDateString() : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Run SVM batch prediction
        async function runSVMBatchPrediction() {
            if (!confirm('Run batch prediction untuk semua siswa dengan pretest?')) return;

            try {
                document.getElementById('svmStatsGrid').innerHTML = '<div style="text-align: center; padding: 20px;"><i class="bx bx-loader-alt bx-spin" style="font-size: 32px; color: #667eea;"></i><p style="margin-top: 12px; color: #6b7280;">Running batch prediction...</p></div>';

                const response = await apiService.fetchWithAuth('/ml/batch-predict', { method: 'POST' });

                if (response.success) {
                    alert(`‚úÖ Batch prediction berhasil!\n\nTotal: ${response.data.total_users}\nSuccess: ${response.data.successful_predictions}\nFailed: ${response.data.failed_predictions}`);
                    loadSVMData();
                } else {
                    alert('‚ùå Batch prediction gagal: ' + (response.error || 'Unknown error'));
                    showSVMEmptyState();
                }
            } catch (error) {
                console.error('Error running batch prediction:', error);
                alert('‚ùå Error: ' + error.message);
                showSVMEmptyState();
            }
        }

        // Show empty state
        function showSVMEmptyState() {
            document.getElementById('svmStatsGrid').innerHTML = '';
            document.getElementById('svmChartsContainer').style.display = 'none';
            document.getElementById('svmTableContainer').style.display = 'none';
            document.getElementById('svmEmptyState').style.display = 'block';
        }

        // Load SVM data on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadSVMData();
            }, 1000);
        });
        // User dropdown toggle
        (function() {
            const userMenuToggle = document.getElementById('userMenuToggle');
            const userDropdown = document.getElementById('userDropdown');

            if (userMenuToggle && userDropdown) {
                userMenuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('active');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenuToggle.contains(e.target)) {
                        userDropdown.classList.remove('active');
                    }
                });

                // Update dropdown user info
                const currentUser = authService.getCurrentUser();
                if (currentUser) {
                    const dropdownUserName = document.getElementById('dropdownUserName');
                    const dropdownUserEmail = document.getElementById('dropdownUserEmail');
                    if (dropdownUserName) dropdownUserName.textContent = currentUser.name || 'Assessor';
                    if (dropdownUserEmail) dropdownUserEmail.textContent = currentUser.email || '';
                }
            }
        })();

    </script>
    <script src="../../js/assessor-navbar.js"></script>
</body>
</html>
