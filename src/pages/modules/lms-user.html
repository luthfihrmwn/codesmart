<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#754ef9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CodeSmart">

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/src/images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/src/images/icon-192x192.png">

    <title>Learning Module - CodeSmart LMS</title>

    <!-- box icons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- custom css -->
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="stylesheet" href="../../css/pwa.css">
    <link rel="stylesheet" href="../../css/lms.css">

    <style>
        body {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <!-- PWA Loading Splash Screen -->
    <div class="pwa-loading" id="pwaLoading">
        <div class="pwa-loading-logo">
            <i class='bx bx-code-alt'></i> CodeSmart
        </div>
        <div class="pwa-loading-spinner"></div>
        <p class="pwa-loading-text">Loading LMS...</p>
    </div>

    <!-- LMS Container -->
    <div class="lms-container">
        <!-- Left Sidebar - Class Navigation -->
        <aside class="lms-sidebar">
            <h3><i class='bx bx-book-bookmark'></i> Kelas</h3>
            <ul class="class-list" id="classList">
                <!-- Will be populated by JavaScript -->
            </ul>
        </aside>

        <!-- Main Content Area -->
        <main class="lms-content">
            <!-- Header -->
            <div class="lms-header">
                <div class="breadcrumb">
                    <a href="../user/dashboard.html"><i class='bx bx-home'></i> Dashboard</a>
                    <span>/</span>
                    <span id="moduleName">Loading...</span>
                    <span>/</span>
                    <span id="className">...</span>
                </div>
                <h1 id="classTitle">Loading Class...</h1>
            </div>

            <!-- Tabs Navigation -->
            <div class="lms-tabs">
                <button class="lms-tab active" data-tab="material">
                    <i class='bx bx-book-open'></i> Materi
                </button>
                <button class="lms-tab" data-tab="assignments">
                    <i class='bx bx-task'></i> Tugas
                </button>
                <button class="lms-tab" data-tab="discussions">
                    <i class='bx bx-message-dots'></i> Diskusi
                </button>
            </div>

            <!-- Tab: Material -->
            <div class="lms-tab-content active" id="material">
                <div class="material-section" id="materialContent">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div style="margin-top: 3rem; display: flex; justify-content: space-between;">
                    <button class="btn-lms btn-secondary" id="prevClassBtn">
                        <i class='bx bx-chevron-left'></i> Kelas Sebelumnya
                    </button>
                    <button class="btn-lms btn-primary" id="markCompleteBtn">
                        <i class='bx bx-check-circle'></i> Tandai Selesai
                    </button>
                    <button class="btn-lms btn-primary" id="nextClassBtn">
                        Kelas Berikutnya <i class='bx bx-chevron-right'></i>
                    </button>
                </div>
            </div>

            <!-- Tab: Assignments -->
            <div class="lms-tab-content" id="assignments">
                <div class="assignments-list" id="assignmentsList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Tab: Discussions -->
            <div class="lms-tab-content" id="discussions">
                <div style="text-align: center; padding: 4rem; color: #999;">
                    <i class='bx bx-message-square-x' style="font-size: 6rem;"></i>
                    <p style="margin-top: 1.5rem; font-size: 1.6rem;">Fitur diskusi akan segera hadir!</p>
                </div>
            </div>
        </main>

        <!-- Right Sidebar - Info Panel -->
        <aside class="lms-info-panel">
            <!-- Progress Card -->
            <div class="info-card progress-card">
                <h3><i class='bx bx-bar-chart-alt-2'></i> Progress</h3>
                <div class="progress-ring">
                    <svg width="120" height="120">
                        <circle class="progress-bg" cx="60" cy="60" r="52"></circle>
                        <circle class="progress-bar" cx="60" cy="60" r="52"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="0"
                                id="progressCircle"></circle>
                    </svg>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <div class="progress-details" id="progressDetails">
                    0 dari 5 kelas selesai
                </div>
            </div>

            <!-- Classmates Card -->
            <div class="info-card">
                <h3><i class='bx bx-group'></i> Teman Sekelas</h3>
                <div class="classmates-list" id="classmatesList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Assignments Summary Card -->
            <div class="info-card">
                <h3><i class='bx bx-task'></i> Ringkasan Tugas</h3>
                <div style="display: flex; justify-content: space-around; margin-top: 1.5rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 2.4rem; font-weight: 700; color: #fbbf24;" id="pendingCount">0</div>
                        <div style="font-size: 1.2rem; color: #666; margin-top: 0.3rem;">Pending</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.4rem; font-weight: 700; color: #3b82f6;" id="submittedCount">0</div>
                        <div style="font-size: 1.2rem; color: #666; margin-top: 0.3rem;">Dikumpulkan</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2.4rem; font-weight: 700; color: #10b981;" id="gradedCount">0</div>
                        <div style="font-size: 1.2rem; color: #666; margin-top: 0.3rem;">Dinilai</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Assignment Detail Modal -->
    <div class="grading-modal" id="assignmentModal">
        <div class="grading-modal-content">
            <h2 id="assignmentModalTitle">Detail Tugas</h2>

            <div class="assignment-card">
                <h3 id="assignmentTitle">Judul Tugas</h3>
                <p id="assignmentDescription">Deskripsi tugas...</p>
                <div class="assignment-meta">
                    <span><i class='bx bx-calendar'></i> Deadline: <strong id="assignmentDueDate">-</strong></span>
                    <span><i class='bx bx-medal'></i> Nilai Maks: <strong id="assignmentMaxScore">100</strong></span>
                </div>
            </div>

            <!-- Upload Section -->
            <div id="uploadSection">
                <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.8rem;">Upload Tugas</h3>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" style="display: none;"
                           accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.zip">
                    <i class='bx bx-cloud-upload'></i>
                    <p><strong>Klik untuk upload</strong> atau drag & drop file</p>
                    <p class="file-types">Format: PDF, DOC, DOCX, PPT, PPTX, JPG, PNG, ZIP (Max 10MB)</p>
                </div>
                <div id="uploadedFileDisplay" style="display: none;"></div>
                <button class="btn-lms btn-success" id="submitAssignmentBtn" style="width: 100%; margin-top: 1.5rem;" disabled>
                    <i class='bx bx-send'></i> Kumpulkan Tugas
                </button>
            </div>

            <!-- Submission Status -->
            <div id="submissionStatus" style="display: none;">
                <!-- Will show submission info when submitted -->
            </div>

            <div style="margin-top: 2rem;">
                <button class="btn-lms btn-secondary" onclick="closeAssignmentModal()" style="width: 100%;">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../data/database.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="/src/js/pwa.js"></script>

    <script>
        // Initialize
        const authService = new AuthService();
        const currentUser = authService.getCurrentUser();
        let currentModule = null;
        let currentClassId = null;
        let currentAssignmentId = null;
        let uploadedFile = null;

        // Get module level from URL
        const urlParams = new URLSearchParams(window.location.search);
        const moduleLevel = urlParams.get('level') || currentUser.recommendedModule;

        // Check authentication
        if (!currentUser) {
            window.location.href = '../auth/login.html';
        }

        // Load module data
        function loadModule() {
            currentModule = Database.getModuleByLevel(moduleLevel);
            if (!currentModule) {
                alert('Module not found!');
                window.location.href = '../user/dashboard.html';
                return;
            }

            // Auto-enroll user if not enrolled
            Database.enrollUser(currentUser.id, currentModule.id);
            saveToLocalStorage();

            // Update header
            document.getElementById('moduleName').textContent = currentModule.name;

            // Load class list
            loadClassList();

            // Load first class by default
            if (currentModule.classes.length > 0) {
                loadClass(currentModule.classes[0].id);
            }

            // Load classmates
            loadClassmates();

            // Update progress
            updateProgress();
        }

        // Load class list sidebar
        function loadClassList() {
            const classList = document.getElementById('classList');
            const enrollment = Database.getEnrollmentByUserId(currentUser.id, currentModule.id);
            const completedClasses = enrollment ? enrollment.completedClasses : [];

            classList.innerHTML = currentModule.classes.map((cls, index) => `
                <li class="class-item ${cls.id === currentClassId ? 'active' : ''} ${completedClasses.includes(cls.id) ? 'completed' : ''}"
                    onclick="loadClass(${cls.id})">
                    <div class="class-number">${index + 1}</div>
                    <div class="class-info">
                        <div class="class-title">${cls.title}</div>
                        <div class="class-desc">${cls.description}</div>
                    </div>
                </li>
            `).join('');
        }

        // Load class content
        function loadClass(classId) {
            currentClassId = classId;
            const cls = currentModule.classes.find(c => c.id === classId);
            if (!cls) return;

            // Update header
            document.getElementById('className').textContent = cls.title;
            document.getElementById('classTitle').textContent = cls.title;

            // Load material with enhanced content
            loadMaterial(cls);

            // Load assignments for this class
            loadAssignments(classId);

            // Update class list active state
            loadClassList();

            // Update navigation buttons
            updateNavigationButtons();

            // Update assignments summary
            updateAssignmentsSummary();
        }

        // Load material content
        function loadMaterial(cls) {
            const materialContent = document.getElementById('materialContent');

            // Generate rich content based on class
            let content = `
                <h2>${cls.title}</h2>
                <p>${cls.description}</p>

                <h3>Tujuan Pembelajaran</h3>
                <p>Setelah menyelesaikan kelas ini, Anda akan mampu:</p>
                <ul style="font-size: 1.5rem; line-height: 2; margin-left: 2rem;">
                    <li>Memahami konsep dasar ${cls.title.toLowerCase()}</li>
                    <li>Mengimplementasikan ${cls.title.toLowerCase()} dalam project</li>
                    <li>Menyelesaikan masalah menggunakan ${cls.title.toLowerCase()}</li>
                </ul>

                <h3>Materi Pembelajaran</h3>
                <p>${cls.content}</p>
            `;

            // Add code examples
            if (cls.order === 1) {
                content += `
                    <h3>Contoh Kode</h3>
                    <pre><code>// Contoh ${cls.title}
console.log("Hello, JavaScript!");

// Menampilkan pesan
alert("Selamat belajar di CodeSmart!");

// Variabel
let nama = "John Doe";
console.log("Nama saya: " + nama);</code></pre>
                `;
            } else if (cls.order === 2) {
                content += `
                    <h3>Contoh Kode</h3>
                    <pre><code>// Deklarasi variabel
let nama = "Jane";
const umur = 25;
var kota = "Jakarta";

// Tipe data
let angka = 100;          // Number
let teks = "Hello";       // String
let benar = true;         // Boolean
let kosong = null;        // Null
let tidakTerdefinisi;     // Undefined

console.log(typeof angka);  // "number"
console.log(typeof teks);   // "string"</code></pre>
                `;
            }

            // Add video placeholder
            content += `
                <h3>Video Pembelajaran</h3>
                <div style="background: #f0f0f0; padding: 8rem 2rem; text-align: center; border-radius: 1.5rem; margin: 2rem 0;">
                    <i class='bx bx-play-circle' style="font-size: 6rem; color: var(--main-color);"></i>
                    <p style="margin-top: 1.5rem; font-size: 1.6rem; color: #666;">Video pembelajaran akan segera tersedia</p>
                </div>
            `;

            // Add quiz/exercise
            content += `
                <h3>Latihan</h3>
                <div style="background: #f9f7ff; border-left: 4px solid var(--main-color); padding: 2rem; border-radius: 1rem; margin: 2rem 0;">
                    <p style="margin: 0; font-size: 1.5rem;"><strong>Tugas:</strong> Buat program sederhana yang menerapkan konsep ${cls.title.toLowerCase()}. Lihat detail di tab Tugas.</p>
                </div>
            `;

            materialContent.innerHTML = content;
        }

        // Load assignments
        function loadAssignments(classId) {
            const assignments = Database.getAssignmentsByClassId(classId);
            const assignmentsList = document.getElementById('assignmentsList');

            if (assignments.length === 0) {
                assignmentsList.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: #999;">
                        <i class='bx bx-task-x' style="font-size: 6rem;"></i>
                        <p style="margin-top: 1.5rem; font-size: 1.6rem;">Belum ada tugas untuk kelas ini</p>
                    </div>
                `;
                return;
            }

            assignmentsList.innerHTML = assignments.map(assignment => {
                const submission = Database.getUserSubmission(assignment.id, currentUser.id);
                let status = 'pending';
                let statusText = 'Belum Dikumpulkan';

                if (submission) {
                    if (submission.score !== null) {
                        status = 'graded';
                        statusText = `Nilai: ${submission.score}`;
                    } else {
                        status = 'submitted';
                        statusText = 'Menunggu Penilaian';
                    }
                }

                return `
                    <div class="assignment-item ${status}" onclick="openAssignmentModal(${assignment.id})">
                        <h4>${assignment.title}</h4>
                        <p>${assignment.description}</p>
                        <div class="assignment-footer">
                            <span class="due-date">
                                <i class='bx bx-calendar'></i>
                                Deadline: ${new Date(assignment.dueDate).toLocaleDateString('id-ID')}
                            </span>
                            <span class="status-badge ${status}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open assignment modal
        function openAssignmentModal(assignmentId) {
            currentAssignmentId = assignmentId;
            const assignment = Database.assignments.find(a => a.id === assignmentId);
            const submission = Database.getUserSubmission(assignmentId, currentUser.id);

            // Populate modal
            document.getElementById('assignmentModalTitle').textContent = assignment.title;
            document.getElementById('assignmentTitle').textContent = assignment.title;
            document.getElementById('assignmentDescription').textContent = assignment.description;
            document.getElementById('assignmentDueDate').textContent = new Date(assignment.dueDate).toLocaleDateString('id-ID');
            document.getElementById('assignmentMaxScore').textContent = assignment.maxScore;

            // Show upload section or submission status
            if (submission) {
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('submissionStatus').style.display = 'block';

                let statusHTML = `
                    <div class="submission-status ${submission.score !== null ? 'graded' : 'submitted'}">
                        <h4><i class='bx bx-check-circle'></i> Status Pengumpulan</h4>
                        <p><strong>File:</strong> ${submission.fileName}</p>
                        <p><strong>Dikumpulkan:</strong> ${new Date(submission.submittedAt).toLocaleDateString('id-ID')}</p>
                `;

                if (submission.score !== null) {
                    statusHTML += `
                        <div class="score">${submission.score} / ${assignment.maxScore}</div>
                        ${submission.feedback ? `
                            <div class="feedback">
                                <strong>Feedback dari Assessor:</strong><br>
                                ${submission.feedback}
                            </div>
                        ` : ''}
                    `;
                } else {
                    statusHTML += `<p style="color: #3b82f6; font-weight: 600;">Tugas Anda sedang dalam proses penilaian</p>`;
                }

                statusHTML += `</div>`;
                document.getElementById('submissionStatus').innerHTML = statusHTML;
            } else {
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('submissionStatus').style.display = 'none';
                setupFileUpload();
            }

            // Show modal
            document.getElementById('assignmentModal').classList.add('active');
        }

        // Close assignment modal
        function closeAssignmentModal() {
            document.getElementById('assignmentModal').classList.remove('active');
            uploadedFile = null;
            document.getElementById('uploadedFileDisplay').style.display = 'none';
            document.getElementById('submitAssignmentBtn').disabled = true;
        }

        // Setup file upload
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.onclick = () => fileInput.click();

            fileInput.onchange = (e) => {
                handleFileSelect(e.target.files[0]);
            };

            // Drag and drop
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };

            uploadArea.ondragleave = () => {
                uploadArea.classList.remove('dragover');
            };

            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files[0]);
            };
        }

        // Handle file select
        function handleFileSelect(file) {
            if (!file) return;

            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert('File terlalu besar! Maksimal 10MB');
                return;
            }

            // Validate file type
            const allowedTypes = ['application/pdf', 'application/msword',
                                 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                 'application/vnd.ms-powerpoint',
                                 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                 'image/jpeg', 'image/png', 'application/zip'];

            if (!allowedTypes.includes(file.type)) {
                alert('Format file tidak didukung!');
                return;
            }

            uploadedFile = file;

            // Display uploaded file
            const display = document.getElementById('uploadedFileDisplay');
            display.innerHTML = `
                <div class="uploaded-file">
                    <div class="file-info">
                        <i class='bx bx-file'></i>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                    </div>
                    <button class="remove-file" onclick="removeFile()">
                        <i class='bx bx-trash'></i> Hapus
                    </button>
                </div>
            `;
            display.style.display = 'block';

            // Enable submit button
            document.getElementById('submitAssignmentBtn').disabled = false;
        }

        // Remove file
        function removeFile() {
            uploadedFile = null;
            document.getElementById('uploadedFileDisplay').style.display = 'none';
            document.getElementById('submitAssignmentBtn').disabled = true;
        }

        // Submit assignment
        document.getElementById('submitAssignmentBtn').onclick = function() {
            if (!uploadedFile) {
                alert('Pilih file terlebih dahulu!');
                return;
            }

            // In real app, upload file to server
            // For now, just save filename
            const submission = Database.submitAssignment({
                assignmentId: currentAssignmentId,
                userId: currentUser.id,
                fileName: uploadedFile.name,
                fileData: null // In production, store file reference/URL
            });

            saveToLocalStorage();

            alert('Tugas berhasil dikumpulkan!');
            closeAssignmentModal();
            loadAssignments(currentClassId);
            updateAssignmentsSummary();
        };

        // Load classmates
        function loadClassmates() {
            const classmates = Database.getClassmates(currentUser.id, currentModule.id);
            const classmatesList = document.getElementById('classmatesList');

            if (classmates.length === 0) {
                classmatesList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #999; font-size: 1.3rem;">
                        Belum ada teman sekelas
                    </div>
                `;
                return;
            }

            classmatesList.innerHTML = classmates.map(classmate => {
                const initials = classmate.name.split(' ').map(n => n[0]).join('').toUpperCase();
                return `
                    <div class="classmate-item">
                        <div class="classmate-avatar">${initials}</div>
                        <div class="classmate-info">
                            <div class="classmate-name">${classmate.name}</div>
                            <div class="classmate-progress">Progress: ${classmate.progress}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update progress
        function updateProgress() {
            const enrollment = Database.getEnrollmentByUserId(currentUser.id, currentModule.id);
            const progress = enrollment ? enrollment.progress : 0;
            const completed = enrollment ? enrollment.completedClasses.length : 0;
            const total = currentModule.classes.length;

            // Update progress ring
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 52;
            const offset = circumference - (progress / 100) * circumference;
            circle.style.strokeDashoffset = offset;

            // Update text
            document.getElementById('progressText').textContent = progress + '%';
            document.getElementById('progressDetails').textContent = `${completed} dari ${total} kelas selesai`;
        }

        // Update assignments summary
        function updateAssignmentsSummary() {
            const allAssignments = currentModule.classes.flatMap(cls => Database.getAssignmentsByClassId(cls.id));
            let pending = 0, submitted = 0, graded = 0;

            allAssignments.forEach(assignment => {
                const submission = Database.getUserSubmission(assignment.id, currentUser.id);
                if (!submission) {
                    pending++;
                } else if (submission.score !== null) {
                    graded++;
                } else {
                    submitted++;
                }
            });

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('submittedCount').textContent = submitted;
            document.getElementById('gradedCount').textContent = graded;
        }

        // Mark class as complete
        document.getElementById('markCompleteBtn').onclick = function() {
            Database.markClassComplete(currentUser.id, currentModule.id, currentClassId);
            saveToLocalStorage();
            updateProgress();
            loadClassList();
            alert('Kelas berhasil ditandai sebagai selesai!');
        };

        // Navigation buttons
        function updateNavigationButtons() {
            const currentIndex = currentModule.classes.findIndex(c => c.id === currentClassId);
            const prevBtn = document.getElementById('prevClassBtn');
            const nextBtn = document.getElementById('nextClassBtn');

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === currentModule.classes.length - 1;

            prevBtn.onclick = () => {
                if (currentIndex > 0) {
                    loadClass(currentModule.classes[currentIndex - 1].id);
                }
            };

            nextBtn.onclick = () => {
                if (currentIndex < currentModule.classes.length - 1) {
                    loadClass(currentModule.classes[currentIndex + 1].id);
                }
            };
        }

        // Tab switching
        document.querySelectorAll('.lms-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // Update tabs
                document.querySelectorAll('.lms-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update content
                document.querySelectorAll('.lms-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Initialize on load
        window.onload = () => {
            loadModule();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('pwaLoading').style.display = 'none';
            }, 500);
        };

        // Close modal when clicking outside
        document.getElementById('assignmentModal').onclick = function(e) {
            if (e.target === this) {
                closeAssignmentModal();
            }
        };
    </script>
</body>
</html>
