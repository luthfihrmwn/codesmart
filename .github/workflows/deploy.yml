name: CI/CD Deploy CodeSmart

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Install dependencies & build (opsional, jika frontend perlu build)
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install
      working-directory: ./backend  # ganti sesuai struktur folder backend

    - name: Build frontend (jika ada)
      run: npm run build
      working-directory: ./frontend  # jika frontend perlu build, sesuaikan folder

    # 3️⃣ Deploy ke server via SSH
    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        script: |
          echo "Backup existing project..."
          cp -r /var/www/codesmart /var/www/codesmart_backup_$(date +%F_%H-%M-%S)

          echo "Sync repository files..."
          rsync -avz --delete ./ /var/www/codesmart/

          echo "Install backend dependencies..."
          cd /var/www/codesmart/backend
          npm install

          echo "Restart Node.js server..."
          # Ganti 'codesmart' dengan nama process Node.js Anda di pm2
          pm2 restart codesmart || pm2 start server.js --name codesmart

          echo "Reload Nginx..."
          systemctl reload nginx

          echo "Deployment finished!"

